<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Configuración para GitHub Pages -->
    <!--/* <base href="/antologia-box23/"> */-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antología Box23 - Sistema de Gestión</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --color-primary: #27F9D4;
            --color-secondary: #FF729F;
            --color-background: #273043;
            --color-dark: #1a2332;
            --color-light: #f8f9fa;
            --color-table-header: #424b5f;
            --color-table-hover: #324466;
            --color-table: #3a4357;
        }

        body {
            background-color: var(--color-background);
            color: var(--color-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar-brand {
            color: var(--color-primary) !important;
            font-weight: bold;
            font-size: 1.5rem;
        }

        .navbar-brand img {
            height: 50px;
            margin-right: 10px;
        }

        .card {
            background-color: var(--color-dark);
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            color: var(--color-light);
        }

        .card-header {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: var(--color-dark);
            border-bottom: none;
            border-radius: 10px 10px 0 0 !important;
            font-weight: bold;
        }

        .nav-tabs {
            border-bottom: 2px solid var(--color-primary);
        }

        .nav-tabs .nav-link {
            color: var(--color-light);
            border: none;
            padding: 12px 20px;
        }

        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: var(--color-dark);
            border: none;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
        }

        .table {
            color: var(--color-light) !important;
            border-collapse: separate;
            border-spacing: 0;
            background-color: var(--color-table) !important;
        }

        .table th {
            background-color: var(--color-table-header);
            color: var(--color-primary) !important;
            border-color: rgba(255, 255, 255, 0.1);
            padding: 12px 15px;
            position: sticky;
            top: 0;
        }

        .table td {
            border-color: rgba(255, 255, 255, 0.1);
            color: var(--color-light) !important;
            padding: 10px 15px;
            vertical-align: middle;
            background-color: var(--color-table) !important;
        }

        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(255, 255, 255, 0.05) !important;
        }

        .table-hover tbody tr:hover {
            background-color: var(--color-table-hover) !important;
        }

        .form-control,
        .form-select {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--color-light);
        }

        .form-control:focus,
        .form-select:focus {
            background-color: rgba(255, 255, 255, 0.15);
            border-color: var(--color-primary);
            box-shadow: 0 0 0 0.25rem rgba(39, 249, 212, 0.25);
            color: var(--color-light);
        }

        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .btn-primary {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            color: var(--color-dark);
            font-weight: bold;
        }

        .btn-primary:hover {
            background-color: #1de5c0;
            border-color: #1de5c0;
            color: var(--color-dark);
        }

        .btn-success {
            background-color: var(--color-secondary);
            border-color: var(--color-secondary);
            color: white;
        }

        .btn-success:hover {
            background-color: #ff5a8f;
            border-color: #ff5a8f;
            color: white;
        }

        .btn-info {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            color: var(--color-dark);
        }
        
        .expired-classes-highlight {
            background-color: rgba(255, 114, 159, 0.3);
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .summary-card {
            border-left: 4px solid var(--color-primary);
            color: var(--color-light);
        }

        .summary-card .card-title {
            color: var(--color-primary);
        }

        .summary-card .card-text {
            color: var(--color-light);
        }

        #exportBtn {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            border: none;
            color: var(--color-dark);
            font-weight: bold;
        }

        .class-time {
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--color-light);
        }

        .class-time h6 {
            color: var(--color-primary);
        }

        .attendance-badge {
            font-size: 0.85em;
            padding: 5px 8px;
        }

        .package-warning {
            background-color: rgba(255, 114, 159, 0.2);
            border-left: 4px solid var(--color-secondary);
            color: var(--color-light);
        }

        .membership-warning {
            background-color: rgba(255, 193, 7, 0.2);
            border-left: 4px solid #ffc107;
            color: var(--color-light);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .import-export-card {
            border: 2px dashed var(--color-primary);
            color: var(--color-light);
        }

        .whatsapp-modal .message-preview {
            background-color: rgba(39, 249, 212, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #25D366;
            color: var(--color-light);
        }

        .autorestore-section {
            background-color: rgba(39, 249, 212, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            color: var(--color-light);
        }

        .fix-highlight {
            background-color: rgba(39, 249, 212, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid var(--color-primary);
            color: var(--color-light);
        }

        .tab-content {
            min-height: 500px;
        }

        .modal-content {
            background-color: var(--color-dark);
            color: var(--color-light);
        }

        .modal-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--color-dark);
        }

        .modal-footer {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .form-label {
            color: var(--color-primary);
        }

        .text-muted {
            color: rgba(255, 255, 255, 0.6) !important;
        }

        .alert-warning {
            background-color: rgba(255, 193, 7, 0.2);
            border-color: #ffc107;
            color: var(--color-light);
        }

        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%2327F9D4' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
        }

        .form-select option {
            background-color: var(--color-dark);
            color: var(--color-light);
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .logo-placeholder {
            width: 200px;
            height: 100px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-dark);
            font-weight: bold;
            font-size: 24px;
            margin: 0 auto;
        }

        .date-range {
            background-color: rgba(39, 249, 212, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .table-container {
            background-color: var(--color-dark);
            padding: 15px;
            border-radius: 10px;
            max-height: 500px;
            overflow-y: auto;
        }

        .report-summary {
            background-color: rgba(39, 249, 212, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .total-row {
            font-weight: bold;
            background-color: rgba(39, 249, 212, 0.2) !important;
        }

        .whatsapp-survey {
            background-color: rgba(39, 249, 212, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .backup-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050;
            background-color: var(--color-secondary);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: none;
        }

        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }

        .table thead th {
            border-bottom: 2px solid var(--color-primary);
        }

        .badge {
            font-weight: 500;
        }

        .file-input-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .google-form-link {
            color: var(--color-primary);
            text-decoration: none;
            border-bottom: 1px dashed var(--color-primary);
        }

        .google-form-link:hover {
            color: #1de5c0;
            text-decoration: none;
            border-bottom: 1px solid #1de5c0;
        }

        .validation-error {
            border: 1px solid #ff5a8f !important;
            box-shadow: 0 0 0 0.25rem rgba(255, 90, 143, 0.25) !important;
        }

        .user-status-badge {
            font-size: 0.75em;
            padding: 3px 6px;
        }

        .search-box {
            margin-bottom: 15px;
        }

        .emergency-info {
            background-color: rgba(255, 114, 159, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            border-left: 4px solid var(--color-secondary);
        }

        .phone-validation-error {
            color: #ff5a8f;
            font-size: 0.875em;
            margin-top: 0.25rem;
            display: none;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* Estilos para la nueva sección de asistencias mejorada */
        .attendance-user-list {
            background-color: var(--color-dark);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .attendance-user-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--color-light) !important;
        }

        .attendance-user-item:last-child {
            border-bottom: none;
        }

        .attendance-user-info {
            flex: 1;
        }

        .attendance-user-name {
            font-weight: 500;
            color: var(--color-light) !important;
            margin-bottom: 5px;
        }

        .attendance-user-details {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7) !important;
        }

        .attendance-check-container {
            margin-right: 15px;
        }

        .attendance-actions {
            display: flex;
            gap: 10px;
        }

        /* Asegurar que todo el texto en la sección de asistencia sea blanco */
        #attendance * {
            color: var(--color-light) !important;
        }

        .attendance-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .attendance-stat-item {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 10px 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .attendance-stat-icon {
            font-size: 1.5rem;
            color: var(--color-primary);
        }

        .attendance-stat-content h5 {
            margin: 0;
            font-size: 1.2rem;
        }

        .attendance-stat-content p {
            margin: 0;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .attendance-filters {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .attendance-quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        /* Estilos para el modal de importación */
        .import-summary {
            max-height: 300px;
            overflow-y: auto;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
        }

        .import-summary-item {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .import-summary-item:last-child {
            border-bottom: none;
        }

        .import-success {
            color: var(--color-primary);
        }

        .import-warning {
            color: #ffc107;
        }

        .import-error {
            color: #ff5a8f;
        }

        /* Estilos para el modal de cumpleaños */
        .birthday-badge {
            background: linear-gradient(135deg, #FF729F, #FFB347);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-left: 10px;
        }

        .birthday-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .birthday-item:last-child {
            border-bottom: none;
        }

        .birthday-user-info {
            flex: 1;
        }

        .birthday-user-name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .birthday-user-details {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .birthday-date {
            font-weight: bold;
            color: var(--color-primary);
        }

        .birthday-actions {
            display: flex;
            gap: 10px;
        }

        /* Estilos para las alertas de inasistencias */
        .absence-alert-item {
            background-color: rgba(255, 193, 7, 0.2);
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .absence-alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .absence-alert-actions {
            display: flex;
            gap: 10px;
        }

        /* Estilos para los nuevos reportes mensuales */
        .monthly-report-card {
            border: 2px solid var(--color-primary);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .monthly-report-header {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: var(--color-dark);
            padding: 15px;
            border-radius: 8px 8px 0 0;
        }
        
        .monthly-report-body {
            padding: 20px;
            background-color: var(--color-dark);
            border-radius: 0 0 8px 8px;
        }
        
        .report-user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .report-user-item:last-child {
            border-bottom: none;
        }
        
        .report-user-name {
            flex: 1;
            font-weight: 500;
        }
        
        .report-user-count {
            font-weight: bold;
            color: var(--color-primary);
            min-width: 60px;
            text-align: right;
        }
        
        .report-type-badge {
            background-color: rgba(39, 249, 212, 0.2);
            color: var(--color-primary);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        
        .report-month-selector {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        /* Estilos para nuevo reporte combinado */
        .combined-report-card {
            border: 2px solid var(--color-secondary);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .combined-report-header {
            background: linear-gradient(135deg, #FF729F, #FFB347);
            color: var(--color-dark);
            padding: 15px;
            border-radius: 8px 8px 0 0;
        }

        /* Estilos para administración del dinero */
        .money-management-card {
            border: 2px solid #7C77B9;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .money-management-header {
            background: linear-gradient(135deg, #7C77B9, #1D8A99);
            color: var(--color-dark);
            padding: 15px;
            border-radius: 8px 8px 0 0;
        }
        
        .account-balance {
            background-color: rgba(124, 119, 185, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .account-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .account-item:last-child {
            border-bottom: none;
        }
        
        .account-name {
            flex: 1;
            font-weight: 500;
        }
        
        .account-balance-amount {
            font-weight: bold;
            color: var(--color-primary);
            min-width: 100px;
            text-align: right;
        }
        
        .expense-category-badge {
            background-color: rgba(255, 114, 159, 0.2);
            color: var(--color-secondary);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        
        .total-balance {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--color-primary);
            text-align: center;
            padding: 15px;
            border-top: 2px solid rgba(255, 255, 255, 0.1);
            margin-top: 15px;
        }

        /* Estilos para control de personal */
        .staff-control-card {
            border: 2px solid #F0F66E;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .staff-control-header {
            background: linear-gradient(135deg, #F0F66E, #F7934C);
            color: var(--color-dark);
            padding: 15px;
            border-radius: 8px 8px 0 0;
        }
        
        .trainer-payment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .trainer-payment-item:last-child {
            border-bottom: none;
        }
        
        .trainer-info {
            flex: 1;
        }
        
        .trainer-name {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .trainer-details {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .payment-amount {
            font-weight: bold;
            color: #F0F66E;
            min-width: 120px;
            text-align: right;
        }
        
        .class-record-item {
            background-color: rgba(240, 246, 110, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .class-time-badge {
            background-color: rgba(39, 249, 212, 0.2);
            color: var(--color-primary);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        @media (max-width: 768px) {
            .attendance-stats {
                flex-direction: column;
            }

            .attendance-stat-item {
                width: 100%;
            }

            .attendance-user-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .attendance-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .birthday-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .birthday-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .absence-alert-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .absence-alert-actions {
                width: 100%;
                justify-content: flex-start;
            }
            
            .report-user-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .report-user-count {
                align-self: flex-end;
            }
            
            .account-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .account-balance-amount {
                align-self: flex-end;
            }
            
            .trainer-payment-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .payment-amount {
                align-self: flex-end;
            }
        }
    </style>
</head>

<body>
    <!-- Modal para WhatsApp -->
    <div class="modal fade" id="whatsappModal" tabindex="-1" aria-labelledby="whatsappModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)); color: var(--color-dark);">
                    <h5 class="modal-title" id="whatsappModalLabel"><i class="fab fa-whatsapp"></i> Enviar mensaje por
                        WhatsApp</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body whatsapp-modal">
                    <div class="mb-3">
                        <label for="whatsappNumber" class="form-label">Número de teléfono *</label>
                        <input type="tel" class="form-control" id="whatsappNumber" placeholder="3001234567" required>
                        <div class="phone-validation-error" id="whatsappPhoneError">Formato inválido. Use 10 dígitos sin
                            espacios ni símbolos.</div>
                    </div>
                    <div class="mb-3">
                        <label for="whatsappMessage" class="form-label">Mensaje personalizado *</label>
                        <textarea class="form-control" id="whatsappMessage" rows="4" required></textarea>
                    </div>
                    <div class="message-preview">
                        <strong>Vista previa:</strong>
                        <div id="messagePreview"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <a id="whatsappLink" class="btn btn-success" target="_blank">
                        <i class="fab fa-whatsapp"></i> Enviar por WhatsApp
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar usuario -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)); color: var(--color-dark);">
                    <h5 class="modal-title" id="editUserModalLabel"><i class="fas fa-user-edit"></i> Editar Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editName" class="form-label">Nombre completo *</label>
                                <input type="text" class="form-control" id="editName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editDocument" class="form-label">Documento *</label>
                                <input type="text" class="form-control" id="editDocument" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editBirthdate" class="form-label">Fecha de nacimiento</label>
                                <input type="date" class="form-control" id="editBirthdate">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editPhone" class="form-label">Teléfono *</label>
                                <input type="tel" class="form-control" id="editPhone" placeholder="3001234567" required>
                                <div class="phone-validation-error" id="editPhoneError">Formato inválido. Use 10 dígitos
                                    sin espacios ni símbolos.</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editEps" class="form-label">EPS</label>
                                <input type="text" class="form-control" id="editEps">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editRh" class="form-label">RH *</label>
                                <select class="form-select" id="editRh" required>
                                    <option value="">Seleccionar tipo de sangre</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                    <option value="O+">O+</option>
                                    <option value="O">O-</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editPathology" class="form-label">Patología</label>
                                <input type="text" class="form-control" id="editPathology">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editEmergencyContact" class="form-label">Contacto de emergencia *</label>
                                <input type="text" class="form-control" id="editEmergencyContact" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editEmergencyPhone" class="form-label">Teléfono de emergencia *</label>
                                <input type="tel" class="form-control" id="editEmergencyPhone" placeholder="3001234567"
                                    required>
                                <div class="phone-validation-error" id="editEmergencyPhoneError">Formato inválido. Use
                                    10 dígitos sin espacios ni símbolos.</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editClassTime" class="form-label">Clase habitual *</label>
                                <select class="form-select" id="editClassTime" required>
                                    <option value="">Seleccionar clase</option>
                                    <option value="5:00 am">5:00 am</option>
                                    <option value="6:00 am">6:00 am</option>
                                    <option value="7:00 am">7:00 am</option>
                                    <option value="8:00 am">8:00 am</option>
                                    <option value="4:00 pm">4:00 pm</option>
                                    <option value="5:30 pm">5:30 pm</option>
                                    <option value="6:30 pm">6:30 pm</option>
                                    <option value="7:30 pm">7:30 pm</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editAffiliationType" class="form-label">Tipo de afiliación *</label>
                                <select class="form-select" id="editAffiliationType" required>
                                    <option value="">Seleccionar tipo</option>
                                    <option value="mensualidad">Mensualidad</option>
                                    <option value="paquete 10 clases">Paquete 10 clases</option>
                                    <option value="personalizado Diana">Personalizado Diana</option>
                                    <option value="clase suelta">Clase suelta</option>
                                    <option value="pole">Pole</option>
                                    <option value="telas">Telas</option>
                                    <option value="gap">GAP</option>
                                    <option value="flex">FLEX</option>
                                    <option value="Entrenador(a)">Entrenador(a)</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editStatus" class="form-label">Estado *</label>
                                <select class="form-select" id="editStatus" required>
                                    <option value="active">Activo</option>
                                    <option value="inactive">Inactivo</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveEditUser">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para información de emergencia -->
    <div class="modal fade" id="emergencyInfoModal" tabindex="-1" aria-labelledby="emergencyInfoModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)); color: var(--color-dark);">
                    <h5 class="modal-title" id="emergenceInfoModalLabel"><i class="fas fa-first-aid"></i> Información de
                        Emergencia</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="emergencyInfoContent">
                        <!-- La información se cargará aquí dinámicamente -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para confirmación de pago -->
    <div class="modal fade" id="paymentConfirmationModal" tabindex="-1" aria-labelledby="paymentConfirmationModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)); color: var(--color-dark);">
                    <h5 class="modal-title" id="paymentConfirmationModalLabel"><i class="fas fa-check-circle"></i> Pago
                        Registrado</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>El pago se ha registrado correctamente. ¿Desea enviar un mensaje de confirmación por WhatsApp?
                    </p>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="sendWhatsAppConfirmation" checked>
                        <label class="form-check-label" for="sendWhatsAppConfirmation">
                            Enviar mensaje de confirmación
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-success" id="sendConfirmationBtn">
                        <i class="fab fa-whatsapp"></i> Enviar Confirmación
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para formulario WhatsApp -->
    <div class="modal fade" id="whatsappFormModal" tabindex="-1" aria-labelledby="whatsappFormModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)); color: var(--color-dark);">
                    <h5 class="modal-title" id="whatsappFormModalLabel"><i class="fab fa-whatsapp"></i> Formulario de
                        Recolección de Datos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Este formulario genera un mensaje para solicitar datos a
                        nuevos usuarios por WhatsApp.
                    </div>
                    <form id="whatsappDataForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="clientName" class="form-label">Nombre del Cliente</label>
                                <input type="text" class="form-control" id="clientName">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="clientPhone" class="form-label">Teléfono</label>
                                <input type="tel" class="form-control" id="clientPhone" placeholder="3001234567">
                                <div class="phone-validation-error" id="clientPhoneError">Formato inválido. Use 10
                                    dígitos sin espacios ni símbolos.</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="whatsappGroupLink" class="form-label">Enlace del Grupo de WhatsApp</label>
                            <input type="url" class="form-control" id="whatsappGroupLink"
                                value="https://chat.whatsapp.com/DSJzYAb6h58FQDA8yEAzwN"
                                placeholder="https://chat.whatsapp.com/...">
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="includeGroupLink" checked>
                            <label class="form-check-label" for="includeGroupLink">
                                Incluir enlace al grupo en el mensaje
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="includeGoogleForm" checked>
                            <label class="form-check-label" for="includeGoogleForm">
                                Incluir enlace al formulario de Google
                            </label>
                        </div>
                    </form>
                    <div class="whatsapp-survey">
                        <h6>Vista previa del mensaje:</h6>
                        <div id="whatsappFormPreview" class="message-preview">
                            El mensaje se generará automáticamente...
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <a id="whatsappFormLink" class="btn btn-success" target="_blank">
                        <i class="fab fa-whatsapp"></i> Abrir en WhatsApp
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para resumen de importación -->
    <div class="modal fade" id="importSummaryModal" tabindex="-1" aria-labelledby="importSummaryModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)); color: var(--color-dark);">
                    <h5 class="modal-title" id="importSummaryModalLabel"><i class="fas fa-file-import"></i> Resumen de
                        Importación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="importSummaryContent">
                        <!-- El resumen se cargará aquí dinámicamente -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="confirmImportBtn">Confirmar Importación</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para cumpleaños -->
    <div class="modal fade" id="birthdayModal" tabindex="-1" aria-labelledby="birthdayModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)); color: var(--color-dark);">
                    <h5 class="modal-title" id="birthdayModalLabel"><i class="fas fa-birthday-cake"></i> <span
                            id="birthdayModalTitle">Cumpleaños</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="birthdayContent">
                        <!-- La lista de cumpleaños se cargará aquí dinámicamente -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-success" id="sendBirthdayWishes">
                        <i class="fab fa-whatsapp"></i> Enviar Felicitaciones
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL 1: Administración del Dinero -->
    <div class="modal fade" id="moneyManagementModal" tabindex="-1" aria-labelledby="moneyManagementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, #7C77B9, #1D8A99); color: var(--color-dark);">
                    <h5 class="modal-title" id="moneyManagementModalLabel"><i class="fas fa-chart-pie"></i> Administración del Dinero</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-4" id="moneyManagementTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="balances-tab" data-bs-toggle="tab" data-bs-target="#balances" type="button" role="tab">Saldos por Cuenta</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="expenses-tab" data-bs-toggle="tab" data-bs-target="#expenses" type="button" role="tab">Registrar Gastos</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="expenseHistory-tab" data-bs-toggle="tab" data-bs-target="#expenseHistory" type="button" role="tab">Historial de Gastos</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="financialReports-tab" data-bs-toggle="tab" data-bs-target="#financialReports" type="button" role="tab">Reportes Financieros</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="moneyManagementTabContent">
                        <!-- Pestaña de Saldos por Cuenta -->
                        <div class="tab-pane fade show active" id="balances" role="tabpanel">
                            <div class="money-management-card">
                                <div class="money-management-header">
                                    <h5 class="mb-0"><i class="fas fa-wallet"></i> Saldos por Cuenta</h5>
                                </div>
                                <div class="monthly-report-body">
                                    <div class="account-balance">
                                        <h6>Resumen de Cuentas</h6>
                                        <p>Ingresos totales por cuenta menos gastos registrados</p>
                                    </div>
                                    
                                    <div id="accountBalancesList">
                                        <!-- Los saldos se cargarán aquí dinámicamente -->
                                    </div>
                                    
                                    <div class="total-balance" id="totalBalance">
                                        Total General: $0.00
                                    </div>
                                    
                                    <div class="alert alert-info mt-3">
                                        <i class="fas fa-info-circle"></i> 
                                        <strong>Nota:</strong> Los saldos se calculan automáticamente restando los gastos registrados de los ingresos por cuenta.
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pestaña de Registrar Gastos -->
                        <div class="tab-pane fade" id="expenses" role="tabpanel">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title mb-0"><i class="fas fa-receipt"></i> Registrar Nuevo Gasto</h5>
                                        </div>
                                        <div class="card-body">
                                            <form id="expenseForm">
                                                <div class="mb-3">
                                                    <label for="expenseDate" class="form-label">Fecha *</label>
                                                    <input type="date" class="form-control" id="expenseDate" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="expenseDescription" class="form-label">Descripción *</label>
                                                    <input type="text" class="form-control" id="expenseDescription" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="expenseAmount" class="form-label">Monto ($) *</label>
                                                    <input type="number" step="0.01" class="form-control" id="expenseAmount" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="expenseCategory" class="form-label">Categoría *</label>
                                                    <select class="form-select" id="expenseCategory" required>
                                                        <option value="">Seleccionar categoría</option>
                                                        <option value="nómina">Nómina</option>
                                                        <option value="arriendo">Arriendo</option>
                                                        <option value="servicios">Servicios públicos</option>
                                                        <option value="mantenimiento">Mantenimiento</option>
                                                        <option value="insumos">Insumos</option>
                                                        <option value="marketing">Marketing</option>
                                                        <option value="impuestos">Impuestos</option>
                                                        <option value="otros">Otros</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="expenseAccount" class="form-label">Cuenta *</label>
                                                    <select class="form-select" id="expenseAccount" required>
                                                        <option value="">Seleccionar cuenta</option>
                                                        <option value="efectivo">Efectivo</option>
                                                        <option value="bancolombia">Bancolombia</option>
                                                        <option value="daviplata">Daviplata</option>
                                                        <option value="nequi">Nequi</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="expenseReceipt" class="form-label">Número de factura/recibo (opcional)</label>
                                                    <input type="text" class="form-control" id="expenseReceipt">
                                                </div>
                                                <button type="submit" class="btn btn-primary w-100">Registrar Gasto</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title mb-0"><i class="fas fa-lightbulb"></i> Consejos para el Control de Gastos</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="alert alert-info">
                                                <h6><i class="fas fa-tips"></i> Buenas Prácticas</h6>
                                                <ul>
                                                    <li>Registre todos los gastos inmediatamente después de realizarlos</li>
                                                    <li>Guarde los recibos físicos o digitales</li>
                                                    <li>Categorice correctamente cada gasto</li>
                                                    <li>Revise periódicamente los reportes de gastos</li>
                                                    <li>Establezca presupuestos por categoría</li>
                                                </ul>
                                            </div>
                                            <div class="alert alert-warning">
                                                <h6><i class="fas fa-exclamation-triangle"></i> Gastos Comunes en Gimnasios</h6>
                                                <ul>
                                                    <li>Nómina de entrenadores</li>
                                                    <li>Mantenimiento de equipos</li>
                                                    <li>Servicios (agua, luz, internet)</li>
                                                    <li>Limpieza y aseo</li>
                                                    <li>Materiales de entrenamiento</li>
                                                    <li>Publicidad y marketing</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pestaña de Historial de Gastos -->
                        <div class="tab-pane fade" id="expenseHistory" role="tabpanel">
                            <div class="money-management-card">
                                <div class="money-management-header">
                                    <h5 class="mb-0"><i class="fas fa-history"></i> Historial de Gastos</h5>
                                </div>
                                <div class="monthly-report-body">
                                    <div class="report-month-selector">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <label for="expenseStartDateFilter" class="form-label">Fecha inicial</label>
                                                <input type="date" class="form-control" id="expenseStartDateFilter">
                                            </div>
                                            <div class="col-md-3">
                                                <label for="expenseEndDateFilter" class="form-label">Fecha final</label>
                                                <input type="date" class="form-control" id="expenseEndDateFilter">
                                            </div>
                                            <div class="col-md-3">
                                                <label for="expenseCategoryFilter" class="form-label">Categoría</label>
                                                <select class="form-select" id="expenseCategoryFilter">
                                                    <option value="">Todas las categorías</option>
                                                    <option value="nómina">Nómina</option>
                                                    <option value="arriendo">Arriendo</option>
                                                    <option value="servicios">Servicios públicos</option>
                                                    <option value="mantenimiento">Mantenimiento</option>
                                                    <option value="insumos">Insumos</option>
                                                    <option value="marketing">Marketing</option>
                                                    <option value="impuestos">Impuestos</option>
                                                    <option value="otros">Otros</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label for="expenseAccountFilter" class="form-label">Cuenta</label>
                                                <select class="form-select" id="expenseAccountFilter">
                                                    <option value="">Todas las cuentas</option>
                                                    <option value="efectivo">Efectivo</option>
                                                    <option value="bancolombia">Bancolombia</option>
                                                    <option value="daviplata">Daviplata</option>
                                                    <option value="nequi">Nequi</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-md-12">
                                                <button class="btn btn-primary w-100" id="filterExpensesBtn">
                                                    <i class="fas fa-filter"></i> Filtrar Gastos
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="table-responsive table-container">
                                        <table class="table table-striped table-hover" id="expensesTable">
                                            <thead>
                                                <tr>
                                                    <th>Fecha</th>
                                                    <th>Descripción</th>
                                                    <th>Categoría</th>
                                                    <th>Cuenta</th>
                                                    <th>Monto</th>
                                                    <th>Factura</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="expensesList">
                                                <!-- Los gastos se cargarán aquí dinámicamente -->
                                            </tbody>
                                            <tfoot>
                                                <tr class="total-row">
                                                    <td colspan="4"><strong>Total de gastos</strong></td>
                                                    <td><strong id="expensesTotal">$0.00</strong></td>
                                                    <td colspan="2"></td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                    
                                    <div class="mt-3 text-center">
                                        <button class="btn btn-success" id="exportExpensesReport">
                                            <i class="fas fa-file-excel"></i> Exportar a Excel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pestaña de Reportes Financieros -->
                        <div class="tab-pane fade" id="financialReports" role="tabpanel">
                            <div class="money-management-card">
                                <div class="money-management-header">
                                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> Reportes Financieros</h5>
                                </div>
                                <div class="monthly-report-body">
                                    <div class="report-month-selector">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label for="financialReportMonth" class="form-label">Seleccionar mes</label>
                                                <input type="month" class="form-control" id="financialReportMonth">
                                            </div>
                                            <div class="col-md-4 d-flex align-items-end">
                                                <button class="btn btn-primary w-100" id="generateFinancialReport">
                                                    <i class="fas fa-chart-bar"></i> Generar Reporte
                                                </button>
                                            </div>
                                            <div class="col-md-4 d-flex align-items-end">
                                                <button class="btn btn-success w-100" id="exportFinancialReport">
                                                    <i class="fas fa-file-excel"></i> Exportar a Excel
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-4">
                                        <div class="col-md-6">
                                            <div class="card summary-card">
                                                <div class="card-body text-center">
                                                    <h5 class="card-title" id="totalIncomeReport">$0</h5>
                                                    <p class="card-text">Ingresos del mes</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card summary-card">
                                                <div class="card-body text-center">
                                                    <h5 class="card-title" id="totalExpensesReport">$0</h5>
                                                    <p class="card-text">Gastos del mes</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-4">
                                        <div class="col-md-6">
                                            <div class="card summary-card">
                                                <div class="card-body text-center">
                                                    <h5 class="card-title" id="netProfitReport">$0</h5>
                                                    <p class="card-text">Utilidad neta</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card summary-card">
                                                <div class="card-body text-center">
                                                    <h5 class="card-title" id="profitMarginReport">0%</h5>
                                                    <p class="card-text">Margen de utilidad</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-4">
                                        <div class="col-md-12">
                                            <div class="chart-container">
                                                <canvas id="financialChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="table-responsive table-container mt-4">
                                        <table class="table table-striped table-hover" id="financialReportTable">
                                            <thead>
                                                <tr>
                                                    <th>Categoría de Gastos</th>
                                                    <th>Monto</th>
                                                    <th>% del total</th>
                                                    <th>Tendencia</th>
                                                </tr>
                                            </thead>
                                            <tbody id="financialReportList">
                                                <tr>
                                                    <td colspan="4" class="text-center text-muted">
                                                        Seleccione un mes y haga clic en "Generar Reporte"
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL 2: Control de Personal -->
    <div class="modal fade" id="staffControlModal" tabindex="-1" aria-labelledby="staffControlModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header"
                    style="background: linear-gradient(135deg, #F0F66E, #F7934C); color: var(--color-dark);">
                    <h5 class="modal-title" id="staffControlModalLabel"><i class="fas fa-users-cog"></i> Control de Personal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-4" id="staffControlTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="registerClass-tab" data-bs-toggle="tab" data-bs-target="#registerClass" type="button" role="tab">Registrar Clase</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="calculatePayment-tab" data-bs-toggle="tab" data-bs-target="#calculatePayment" type="button" role="tab">Calcular Pagos</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="trainerHistory-tab" data-bs-toggle="tab" data-bs-target="#trainerHistory" type="button" role="tab">Historial de Clases</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="staffControlTabContent">
                        <!-- Pestaña de Registrar Clase -->
                        <div class="tab-pane fade show active" id="registerClass" role="tabpanel">
                            <div class="staff-control-card">
                                <div class="staff-control-header">
                                    <h5 class="mb-0"><i class="fas fa-calendar-plus"></i> Registrar Clase Dictada</h5>
                                </div>
                                <div class="monthly-report-body">
                                    <form id="registerClassForm">
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label for="classRecordDate" class="form-label">Fecha *</label>
                                                <input type="date" class="form-control" id="classRecordDate" required>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="classRecordTime" class="form-label">Hora de la clase *</label>
                                                <select class="form-select" id="classRecordTime" required>
                                                    <option value="">Seleccionar hora</option>
                                                    <option value="5:00 am">5:00 am</option>
                                                    <option value="6:00 am">6:00 am</option>
                                                    <option value="7:00 am">7:00 am</option>
                                                    <option value="8:00 am">8:00 am</option>
                                                    <option value="4:00 pm">4:00 pm</option>
                                                    <option value="5:30 pm">5:30 pm</option>
                                                    <option value="6:30 pm">6:30 pm</option>
                                                    <option value="7:30 pm">7:30 pm</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label for="classRecordTrainer" class="form-label">Entrenador *</label>
                                                <select class="form-select" id="classRecordTrainer" required>
                                                    <option value="">Seleccionar entrenador</option>
                                                    <!-- Se llenará dinámicamente con usuarios de tipo Entrenador(a) -->
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="classRecordType" class="form-label">Tipo de clase *</label>
                                                <select class="form-select" id="classRecordType" required>
                                                    <option value="">Seleccionar tipo</option>
                                                    <option value="crossfit">CrossFit</option>
                                                    <option value="pole">Pole</option>
                                                    <option value="telas">Telas</option>
                                                    <option value="gap">GAP</option>
                                                    <option value="flex">FLEX</option>
                                                    <option value="personalizado">Personalizado</option>
                                                    <option value="otro">Otro</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="classRecordDuration" class="form-label">Duración (horas) *</label>
                                                <select class="form-select" id="classRecordDuration" required>
                                                    <option value="1">1 hora</option>
                                                    <option value="1.5">1.5 horas</option>
                                                    <option value="2">2 horas</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="classRecordNotes" class="form-label">Notas adicionales (opcional)</label>
                                            <textarea class="form-control" id="classRecordNotes" rows="2"></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-save"></i> Registrar Clase
                                        </button>
                                    </form>
                                    
                                    <div class="alert alert-info mt-4">
                                        <h6><i class="fas fa-info-circle"></i> Información importante</h6>
                                        <ul class="mb-0">
                                            <li>El valor por hora para entrenadores es de <strong>$10,000 COP</strong></li>
                                            <li>Los pagos se calculan multiplicando las horas trabajadas por $10,000</li>
                                            <li>Los registros se almacenan para consultas históricas</li>
                                            <li>Puede filtrar por período para calcular pagos específicos</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pestaña de Calcular Pagos -->
                        <div class="tab-pane fade" id="calculatePayment" role="tabpanel">
                            <div class="staff-control-card">
                                <div class="staff-control-header">
                                    <h5 class="mb-0"><i class="fas fa-calculator"></i> Calcular Pagos a Entrenadores</h5>
                                </div>
                                <div class="monthly-report-body">
                                    <div class="report-month-selector">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <label for="paymentStartDate" class="form-label">Fecha inicial</label>
                                                <input type="date" class="form-control" id="paymentStartDate">
                                            </div>
                                            <div class="col-md-3">
                                                <label for="paymentEndDate" class="form-label">Fecha final</label>
                                                <input type="date" class="form-control" id="paymentEndDate">
                                            </div>
                                            <div class="col-md-3">
                                                <label for="paymentTrainerFilter" class="form-label">Entrenador</label>
                                                <select class="form-select" id="paymentTrainerFilter">
                                                    <option value="">Todos los entrenadores</option>
                                                    <!-- Se llenará dinámicamente -->
                                                </select>
                                            </div>
                                            <div class="col-md-3 d-flex align-items-end">
                                                <button class="btn btn-primary w-100" id="calculateTrainerPayments">
                                                    <i class="fas fa-calculator"></i> Calcular Pagos
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="table-responsive table-container mt-4">
                                        <table class="table table-striped table-hover" id="trainerPaymentsTable">
                                            <thead>
                                                <tr>
                                                    <th>Entrenador</th>
                                                    <th>Clases dictadas</th>
                                                    <th>Total horas</th>
                                                    <th>Valor por hora</th>
                                                    <th>Total a pagar</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="trainerPaymentsList">
                                                <tr>
                                                    <td colspan="6" class="text-center text-muted">
                                                        Seleccione un período y haga clic en "Calcular Pagos"
                                                    </td>
                                                </tr>
                                            </tbody>
                                            <tfoot>
                                                <tr class="total-row">
                                                    <td colspan="3"><strong>TOTAL GENERAL</strong></td>
                                                    <td><strong>$10,000</strong></td>
                                                    <td><strong id="totalPaymentsAmount">$0</strong></td>
                                                    <td></td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                    
                                    <div class="row mt-4">
                                        <div class="col-md-12">
                                            <div class="alert alert-success">
                                                <h6><i class="fas fa-file-invoice-dollar"></i> Generar reporte de pagos</h6>
                                                <p>Una vez calculados los pagos, puede generar un reporte detallado para contabilidad.</p>
                                                <button class="btn btn-success" id="exportPaymentsReport">
                                                    <i class="fas fa-file-excel"></i> Exportar Reporte de Pagos
                                                </button>
                                                <button class="btn btn-warning ms-2" id="markPaymentsAsPaid">
                                                    <i class="fas fa-check-circle"></i> Marcar como Pagado
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pestaña de Historial de Clases -->
                        <div class="tab-pane fade" id="trainerHistory" role="tabpanel">
                            <div class="staff-control-card">
                                <div class="staff-control-header">
                                    <h5 class="mb-0"><i class="fas fa-history"></i> Historial de Clases por Entrenador</h5>
                                </div>
                                <div class="monthly-report-body">
                                    <div class="report-month-selector">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <label for="historyStartDate" class="form-label">Fecha inicial</label>
                                                <input type="date" class="form-control" id="historyStartDate">
                                            </div>
                                            <div class="col-md-3">
                                                <label for="historyEndDate" class="form-label">Fecha final</label>
                                                <input type="date" class="form-control" id="historyEndDate">
                                            </div>
                                            <div class="col-md-3">
                                                <label for="historyTrainerFilter" class="form-label">Entrenador</label>
                                                <select class="form-select" id="historyTrainerFilter">
                                                    <option value="">Todos los entrenadores</option>
                                                    <!-- Se llenará dinámicamente -->
                                                </select>
                                            </div>
                                            <div class="col-md-3 d-flex align-items-end">
                                                <button class="btn btn-primary w-100" id="filterClassHistory">
                                                    <i class="fas fa-filter"></i> Filtrar Historial
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="table-responsive table-container mt-4">
                                        <table class="table table-striped table-hover" id="classHistoryTable">
                                            <thead>
                                                <tr>
                                                    <th>Fecha</th>
                                                    <th>Hora</th>
                                                    <th>Entrenador</th>
                                                    <th>Tipo de clase</th>
                                                    <th>Duración</th>
                                                    <th>Valor hora</th>
                                                    <th>Valor clase</th>
                                                    <th>Notas</th>
                                                    <th>Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="classHistoryList">
                                                <tr>
                                                    <td colspan="9" class="text-center text-muted">
                                                        Seleccione filtros y haga clic en "Filtrar Historial"
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="row mt-4">
                                        <div class="col-md-6">
                                            <div class="card summary-card">
                                                <div class="card-body text-center">
                                                    <h5 class="card-title" id="totalClassesHistory">0</h5>
                                                    <p class="card-text">Total de clases</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card summary-card">
                                                <div class="card-body text-center">
                                                    <h5 class="card-title" id="totalHoursHistory">0</h5>
                                                    <p class="card-text">Total de horas</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="text-center flex-grow-1 mb-4" style="color: var(--color-primary);">Sistema de Gestión Antología
                Box23</h1>
            <img src="antologia_logo.png" alt="Logo Antología Box23" class="img-fluid" style="max-height: 100px;">
        </div>

        <!-- Sección de restauración automática -->
        <div id="autorestoreSection" class="autorestore-section d-none">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5><i class="fas fa-sync-alt"></i> Restauración automática de datos</h5>
                    <p class="mb-0">Se encontró un archivo de respaldo previo. ¿Desea restaurar los datos?</p>
                </div>
                <div>
                    <button id="restoreAutoBtn" class="btn btn-success me-2">
                        <i class="fas fa-check"></i> Sí, restaurar
                    </button>
                    <button id="skipRestoreBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i> No, empezar nuevo
                    </button>
                </div>
            </div>
        </div>

        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users"
                    type="button" role="tab">Usuarios</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance"
                    type="button" role="tab">Asistencias</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="income-tab" data-bs-toggle="tab" data-bs-target="#income" type="button"
                    role="tab">Pagos</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button"
                    role="tab">Reportes</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button"
                    role="tab">Datos</button>
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <!-- Sección de Registro de Usuarios -->
            <div class="tab-pane fade show active" id="users" role="tabpanel">
                <div class="row">
                    <div class="col-md-5">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0"><i class="fas fa-user-plus"></i> Registrar Nuevo Usuario
                                </h5>
                            </div>
                            <div class="card-body">
                                <form id="userForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="name" class="form-label">Nombre completo *</label>
                                            <input type="text" class="form-control" id="name" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="document" class="form-label">Documento *</label>
                                            <input type="text" class="form-control" id="document" required>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="birthdate" class="form-label">Fecha de nacimiento</label>
                                            <input type="date" class="form-control" id="birthdate">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="phone" class="form-label">Teléfono *</label>
                                            <input type="tel" class="form-control" id="phone" placeholder="3001234567"
                                                required>
                                            <div class="phone-validation-error" id="phoneError">Formato inválido. Use 10
                                                dígitos sin espacios ni símbolos.</div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="eps" class="form-label">EPS</label>
                                            <input type="text" class="form-control" id="eps">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="rh" class="form-label">RH *</label>
                                            <select class="form-select" id="rh" required>
                                                <option value="">Seleccionar tipo de sangre</option>
                                                <option value="A+">A+</option>
                                                <option value="A-">A-</option>
                                                <option value="B+">B+</option>
                                                <option value="B-">B-</option>
                                                <option value="AB+">AB+</option>
                                                <option value="AB-">AB-</option>
                                                <option value="O+">O+</option>
                                                <option value="O-">O-</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="pathology" class="form-label">Patología</label>
                                            <input type="text" class="form-control" id="pathology">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="emergencyContact" class="form-label">Contacto de emergencia
                                                *</label>
                                            <input type="text" class="form-control" id="emergencyContact" required>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="emergencyPhone" class="form-label">Teléfono de emergencia
                                                *</label>
                                            <input type="tel" class="form-control" id="emergencyPhone"
                                                placeholder="3001234567" required>
                                            <div class="phone-validation-error" id="emergencyPhoneError">Formato
                                                inválido. Use 10 dígitos sin espacios ni símbolos.</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="classTime" class="form-label">Clase habitual *</label>
                                            <select class="form-select" id="classTime" required>
                                                <option value="">Seleccionar clase</option>
                                                <option value="5:00 am">5:00 am</option>
                                                <option value="6:00 am">6:00 am</option>
                                                <option value="7:00 am">7:00 am</option>
                                                <option value="8:00 am">8:00 am</option>
                                                <option value="4:00 pm">4:00 pm</option>
                                                <option value="5:30 pm">5:30 pm</option>
                                                <option value="6:30 pm">6:30 pm</option>
                                                <option value="7:30 pm">7:30 pm</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="affiliationType" class="form-label">Tipo de afiliación *</label>
                                            <select class="form-select" id="affiliationType" required>
                                                <option value="">Seleccionar tipo</option>
                                                <option value="mensualidad">Mensualidad</option>
                                                <option value="paquete 10 clases">Paquete 10 clases</option>
                                                <option value="personalizado Diana">Personalizado Diana</option>
                                                <option value="clase suelta">Clase suelta</option>
                                                <option value="pole">Pole</option>
                                                <option value="gap">GAP</option>
                                                <option value="flex">FLEX</option>
                                                <option value="telas">Telas</option>
                                                <option value="Entrenador(a)">Entrenador(a)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="status" class="form-label">Estado *</label>
                                            <select class="form-select" id="status" required>
                                                <option value="active">Activo</option>
                                                <option value="inactive">Inactivo</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100">Guardar Usuario</button>
                                </form>
                                <div class="mt-3 text-center">
                                    <button class="btn btn-outline-info" id="openWhatsAppForm">
                                        <i class="fab fa-whatsapp"></i> Generar formulario para WhatsApp
                                    </button>
                                    <div class="mt-2">
                                        <small class="text-muted">O utiliza nuestro <a
                                                href="https://forms.gle/ZHUj1Q7YiDhE5P498" target="_blank"
                                                class="google-form-link">formulario de Google</a> para recopilar
                                            información</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0"><i class="fas fa-users"></i> Usuarios Registrados</h5>
                                <button class="btn btn-sm btn-outline-warning" id="showBirthdaysThisMonth">
                                    <i class="fas fa-birthday-cake"></i> Cumpleaños del Mes
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="search-box">
                                    <input type="text" class="form-control" id="searchUserInput"
                                        placeholder="Buscar usuario por nombre, documento o información de emergencia...">
                                </div>
                                <div class="table-responsive table-container">
                                    <table class="table table-striped table-hover" id="usersTable">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Nombre</th>
                                                <th>Documento</th>
                                                <th>Teléfono</th>
                                                <th>Clase</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="usersList">
                                            <!-- Los usuarios se cargarán aquí dinámicamente -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección de Registro de Asistencias - MEJORADA -->
            <div class="tab-pane fade" id="attendance" role="tabpanel">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0"><i class="fas fa-calendar-check"></i> Registrar Asistencias
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="attendanceDate" class="form-label">Fecha *</label>
                                        <input type="date" class="form-control" id="attendanceDate" required>
                                    </div>
                                    <div class="col-md-6 d-flex align-items-end">
                                        <button class="btn btn-outline-primary w-100" id="refreshAttendance">
                                            <i class="fas fa-sync-alt"></i> Actualizar Lista
                                        </button>
                                    </div>
                                </div>

                                <div class="attendance-stats mb-4">
                                    <div class="attendance-stat-item">
                                        <div class="attendance-stat-icon">
                                            <i class="fas fa-users"></i>
                                        </div>
                                        <div class="attendance-stat-content">
                                            <h5 id="totalUsersCount">0</h5>
                                            <p>Usuarios Activos</p>
                                        </div>
                                    </div>
                                    <div class="attendance-stat-item">
                                        <div class="attendance-stat-icon">
                                            <i class="fas fa-user-check"></i>
                                        </div>
                                        <div class="attendance-stat-content">
                                            <h5 id="presentUsersCount">0</h5>
                                            <p>Asistencias Hoy</p>
                                        </div>
                                    </div>
                                    <div class="attendance-stat-item">
                                        <div class="attendance-stat-icon">
                                            <i class="fas fa-clock"></i>
                                        </div>
                                        <div class="attendance-stat-content">
                                            <h5 id="pendingUsersCount">0</h5>
                                            <p>Pendientes</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="attendance-quick-actions">
                                    <button class="btn btn-outline-success" id="markAllPresent">
                                        <i class="fas fa-check-circle"></i> Marcar Todos Presentes
                                    </button>
                                    <button class="btn btn-outline-secondary" id="clearAllAttendance">
                                        <i class="fas fa-times-circle"></i> Limpiar Todo
                                    </button>
                                </div>

                                <!-- BUSCADOR MEJORADO PARA ASISTENCIA -->
                                <div class="search-box mb-3">
                                    <input type="text" class="form-control" id="attendanceSearchInput"
                                        placeholder="Buscar usuario por nombre...">
                                </div>

                                <!-- Nueva lista de usuarios para asistencia (orden alfabético) -->
                                <div class="attendance-user-list">
                                    <div id="attendanceUsersList">
                                        <!-- Los usuarios se cargarán aquí dinámicamente en orden alfabético -->
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <button class="btn btn-success w-100" id="saveAttendance">
                                        <i class="fas fa-save"></i> Guardar Todas las Asistencias
                                    </button>
                                </div>

                                <div class="mt-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title mb-0"><i class="fas fa-list"></i> Historial de
                                                Asistencias</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="attendance-filters">
                                                <div class="row">
                                                    <div class="col-md-3">
                                                        <label for="attendanceStartDateFilter" class="form-label">Fecha
                                                            inicial</label>
                                                        <input type="date" class="form-control"
                                                            id="attendanceStartDateFilter">
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label for="attendanceEndDateFilter" class="form-label">Fecha
                                                            final</label>
                                                        <input type="date" class="form-control"
                                                            id="attendanceEndDateFilter">
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label for="attendanceUserFilter"
                                                            class="form-label">Usuario</label>
                                                        <select class="form-select" id="attendanceUserFilter">
                                                            <option value="">Todos los usuarios</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-3 d-flex align-items-end">
                                                        <button class="btn btn-primary w-100"
                                                            id="filterAttendanceBtn">Filtrar</button>
                                                    </div>
                                                </div>
                                                <!-- MEJORA 1: Buscador para historial de asistencias -->
                                                <div class="row mt-3">
                                                    <div class="col-md-12">
                                                        <label for="attendanceTableSearch" class="form-label">Buscar en el historial</label>
                                                        <input type="text" class="form-control" id="attendanceTableSearch" 
                                                               placeholder="Buscar por usuario, clase, estado...">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="table-responsive table-container">
                                                <table class="table table-striped table-hover" id="attendanceTable">
                                                    <thead>
                                                        <tr>
                                                            <th>Fecha</th>
                                                            <th>Usuario</th>
                                                            <th>Clase</th>
                                                            <th>Estado</th>
                                                            <th>Acciones</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="attendanceList">
                                                        <!-- Las asistencias se cargarán aquí dinámicamente -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Alerta de inasistencias consecutivas -->
                                <div class="card mt-4">
                                    <div class="card-header bg-warning text-dark">
                                        <h5 class="card-title mb-0"><i class="fas fa-exclamation-triangle"></i> Alertas
                                            de Inasistencias</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="absenceAlertsList">
                                            <!-- Las alertas se cargarán aquí dinámicamente -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección de Registro de Pagos -->
            <div class="tab-pane fade" id="income" role="tabpanel">
                <div class="row">
                    <div class="col-md-5">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0"><i class="fas fa-money-bill-wave"></i> Registrar Pago</h5>
                            </div>
                            <div class="card-body">
                                <form id="incomeForm">
                                    <!-- BUSCADOR MEJORADO PARA PAGOS -->
                                    <div class="mb-3">
                                        <label for="incomeUserSearch" class="form-label">Buscar usuario</label>
                                        <input type="text" class="form-control" id="incomeUserSearch"
                                            placeholder="Escriba nombre, documento o clase...">
                                    </div>
                                    <div class="mb-3">
                                        <label for="incomeUserSelect" class="form-label">Usuario *</label>
                                        <select class="form-select" id="incomeUserSelect" required>
                                            <option value="">Seleccionar usuario</option>
                                        </select>
                                    </div>
                                    <div class="date-range">
                                        <h6 class="mb-3">Rango de vigencia</h6>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="startDate" class="form-label">Fecha inicial *</label>
                                                <input type="date" class="form-control" id="startDate" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="endDate" class="form-label">Fecha final *</label>
                                                <input type="date" class="form-control" id="endDate" required>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- MODIFICACIÓN 2: Cambio de "Medio de pago" a "Tipo de pago" -->
                                    <div class="mb-3">
                                        <label for="paymentType" class="form-label">Tipo de pago *</label>
                                        <select class="form-select" id="paymentType" required>
                                            <option value="">Seleccionar tipo</option>
                                            <option value="clase suelta">Clase suelta</option>
                                            <option value="paquete 10 clases">Paquete 10 clases</option>
                                            <option value="mensualidad">Mensualidad</option>
                                            <option value="personalizado Diana">Personalizado Diana</option>
                                        </select>
                                    </div>
                                    <!-- NUEVO: Campo para seleccionar la cuenta -->
                                    <div class="mb-3">
                                        <label for="paymentAccount" class="form-label">Cuenta *</label>
                                        <select class="form-select" id="paymentAccount" required>
                                            <option value="">Seleccionar cuenta</option>
                                            <option value="efectivo">Efectivo</option>
                                            <option value="bancolombia">Bancolombia</option>
                                            <option value="daviplata">Daviplata</option>
                                            <option value="nequi">Nequi</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="amount" class="form-label">Monto ($) *</label>
                                        <input type="number" step="0.01" class="form-control" id="amount" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="description" class="form-label">Descripción</label>
                                        <textarea class="form-control" id="description" rows="2"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Registrar Pago</button>
                                    <!-- NUEVO: Botón para abrir administración del dinero -->
                                    <button type="button" class="btn btn-outline-warning mt-3 w-100" id="openMoneyManagementModal">
                                        <i class="fas fa-chart-pie"></i> Administración del Dinero
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0"><i class="fas fa-chart-line"></i> Registro de Pagos</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label for="incomeStartDateFilter" class="form-label">Fecha inicial</label>
                                        <input type="date" class="form-control" id="incomeStartDateFilter">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="incomeEndDateFilter" class="form-label">Fecha final</label>
                                        <input type="date" class="form-control" id="incomeEndDateFilter">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="incomeFilterUser" class="form-label">Usuario</label>
                                        <select class="form-select" id="incomeFilterUser">
                                            <option value="">Todos los usuarios</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 d-flex align-items-end">
                                        <button class="btn btn-primary w-100" id="filterIncomeBtn">Filtrar</button>
                                    </div>
                                </div>
                                <!-- MEJORA 1: Buscador para historial de pagos -->
                                <div class="row mt-3">
                                    <div class="col-md-12">
                                        <label for="incomeTableSearch" class="form-label">Buscar en el historial</label>
                                        <input type="text" class="form-control" id="incomeTableSearch" 
                                               placeholder="Buscar por usuario, tipo de pago, descripción...">
                                    </div>
                                </div>
                                <div class="table-responsive table-container">
                                    <table class="table table-striped table-hover" id="incomeTable">
                                        <thead>
                                            <tr>
                                                <th>Fecha Pago</th>
                                                <th>Usuario</th>
                                                <th>Monto</th>
                                                <th>Tipo</th>
                                                <th>Cuenta</th>
                                                <th>Válido hasta</th>
                                                <th>Descripción</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="incomeList">
                                            <!-- Los pagos se cargarán aquí dinámicamente -->
                                        </tbody>
                                        <tfoot>
                                            <tr class="total-row">
                                                <td colspan="2"><strong>Total</strong></td>
                                                <td><strong id="incomeTotal">$0.00</strong></td>
                                                <td colspan="5"></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <div id="packageWarning" class="alert mt-3 d-none package-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span id="warningText"></span>
                                </div>
                                <!-- NUEVO: Botón para control de personal -->
                                <div class="mt-4 text-center">
                                    <button class="btn btn-outline-info" id="openStaffControlModalFromIncome">
                                        <i class="fas fa-users-cog"></i> Control de Personal
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección de Reportes - MEJORADA -->
            <div class="tab-pane fade" id="reports" role="tabpanel">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0"><i class="fas fa-chart-pie"></i> Reportes y Estadísticas
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="card summary-card">
                                            <div class="card-body text-center">
                                                <h5 class="card-title" id="reportTotalUsers">0</h5>
                                                <p class="card-text">Usuarios activos</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card summary-card">
                                            <div class="card-body text-center">
                                                <h5 class="card-title" id="reportTotalIncome">$0</h5>
                                                <p class="card-text">Ingresos mensuales</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card summary-card">
                                            <div class="card-body text-center">
                                                <h5 class="card-title" id="reportAttendanceRate">0%</h5>
                                                <p class="card-text">Tasa de asistencia</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card summary-card">
                                            <div class="card-body text-center">
                                                <h5 class="card-title" id="reportPackagesCompleted">0</h5>
                                                <p class="card-text">Paquetes completados</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="card-title mb-0">Distribución por tipo de afiliación</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="chart-container">
                                                    <canvas id="affiliationChart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="card-title mb-0">Asistencia por clase</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="chart-container">
                                                    <canvas id="attendanceChart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- NUEVO: Reporte Combinado de Asistencias y Pagos -->
                                <div class="combined-report-card mb-4">
                                    <div class="combined-report-header">
                                        <h5 class="mb-0"><i class="fas fa-file-contract"></i> Reporte Combinado de Asistencias y Pagos</h5>
                                    </div>
                                    <div class="monthly-report-body">
                                        <div class="report-month-selector">
                                            <div class="row">
                                                <div class="col-md-3">
                                                    <label for="combinedReportUser" class="form-label">Usuario</label>
                                                    <select class="form-select" id="combinedReportUser">
                                                        <option value="">Todos los usuarios</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label for="combinedReportStartDate" class="form-label">Fecha inicial</label>
                                                    <input type="date" class="form-control" id="combinedReportStartDate">
                                                </div>
                                                <div class="col-md-3">
                                                    <label for="combinedReportEndDate" class="form-label">Fecha final</label>
                                                    <input type="date" class="form-control" id="combinedReportEndDate">
                                                </div>
                                                <div class="col-md-3 d-flex align-items-end">
                                                    <button class="btn btn-primary w-100" id="generateCombinedReport">
                                                        <i class="fas fa-chart-bar"></i> Generar Reporte
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="table-responsive table-container">
                                            <table class="table table-striped table-hover" id="combinedReportTable">
                                                <thead>
                                                    <tr>
                                                        <th>Usuario</th>
                                                        <th>Teléfono</th>
                                                        <th>Asistencias</th>
                                                        <th>Clases después de vencimiento</th>
                                                        <th>Final Vigencia</th>
                                                        <th>Tipo Pago</th>
                                                        <th>Valor Último Pago</th>
                                                        <th>Estado</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="combinedReportList">
                                                    <tr>
                                                        <td colspan="9" class="text-center text-muted">
                                                            Seleccione filtros y haga clic en "Generar Reporte"
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="mt-3 text-center">
                                            <button class="btn btn-success" id="exportCombinedReport">
                                                <i class="fas fa-file-excel"></i> Exportar a Excel
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- NUEVO: Informe de Asistencias Mensuales por Usuario -->
                                <div class="monthly-report-card mb-4">
                                    <div class="monthly-report-header">
                                        <h5 class="mb-0"><i class="fas fa-user-check"></i> Informe de Asistencias Mensuales por Usuario</h5>
                                    </div>
                                    <div class="monthly-report-body">
                                        <div class="report-month-selector">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <label for="attendanceMonth" class="form-label">Seleccionar mes</label>
                                                    <input type="month" class="form-control" id="attendanceMonth">
                                                </div>
                                                <div class="col-md-4 d-flex align-items-end">
                                                    <button class="btn btn-primary w-100" id="generateAttendanceReport">
                                                        <i class="fas fa-chart-bar"></i> Generar Informe
                                                    </button>
                                                </div>
                                                <div class="col-md-4 d-flex align-items-end">
                                                    <button class="btn btn-success w-100" id="exportAttendanceReport">
                                                        <i class="fas fa-file-excel"></i> Exportar a Excel
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="table-responsive table-container">
                                            <table class="table table-striped table-hover" id="attendanceMonthlyTable">
                                                <thead>
                                                    <tr>
                                                        <th>#</th>
                                                        <th>Usuario</th>
                                                        <th>Clase</th>
                                                        <th>Asistencias</th>
                                                        <th>% Asistencia</th>
                                                        <th>Última asistencia</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="attendanceMonthlyList">
                                                    <tr>
                                                        <td colspan="6" class="text-center text-muted">
                                                            Seleccione un mes y haga clic en "Generar Informe"
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <!-- NUEVO: Informe de Pagos Mensuales por Tipo -->
                                <div class="monthly-report-card">
                                    <div class="monthly-report-header">
                                        <h5 class="mb-0"><i class="fas fa-money-bill-wave"></i> Informe de Pagos Mensuales por Tipo</h5>
                                    </div>
                                    <div class="monthly-report-body">
                                        <div class="report-month-selector">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <label for="incomeMonth" class="form-label">Seleccionar mes</label>
                                                    <input type="month" class="form-control" id="incomeMonth">
                                                </div>
                                                <div class="col-md-4 d-flex align-items-end">
                                                    <button class="btn btn-primary w-100" id="generateIncomeReport">
                                                        <i class="fas fa-chart-pie"></i> Generar Informe
                                                    </button>
                                                </div>
                                                <div class="col-md-4 d-flex align-items-end">
                                                    <button class="btn btn-success w-100" id="exportIncomeReport">
                                                        <i class="fas fa-file-excel"></i> Exportar a Excel
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="chart-container">
                                                    <canvas id="incomeMonthlyChart"></canvas>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="table-responsive table-container">
                                                    <table class="table table-striped table-hover" id="incomeMonthlyTable">
                                                        <thead>
                                                            <tr>
                                                                <th>Tipo de Pago</th>
                                                                <th>Cantidad</th>
                                                                <th>Monto Total</th>
                                                                <th>% del Total</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="incomeMonthlyList">
                                                            <tr>
                                                                <td colspan="4" class="text-center text-muted">
                                                                    Seleccione un mes y haga clic en "Generar Informe"
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                        <tfoot>
                                                            <tr class="total-row">
                                                                <td><strong>TOTAL</strong></td>
                                                                <td><strong id="totalPaymentsCount">0</strong></td>
                                                                <td><strong id="totalPaymentsAmount">$0.00</strong></td>
                                                                <td><strong>100%</strong></td>
                                                            </tr>
                                                        </tfoot>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección de Gestión de Datos -->
            <div class="tab-pane fade" id="data" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card import-export-card">
                            <div class="card-header">
                                <h5 class="card-title mb-0"><i class="fas fa-database"></i> Respaldo de Datos</h5>
                            </div>
                            <div class="card-body text-center">
                                <p class="card-text">Realice una copia de seguridad de todos los datos del sistema</p>
                                <button class="btn btn-success mb-3" id="backupData">
                                    <i class="fas fa-download"></i> Descargar Respaldo Completo
                                </button>
                                <p class="text-muted">Se descargará un archivo Excel con todos los datos actuales</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card import-export-card">
                            <div class="card-header">
                                <h5 class="card-title mb-0"><i class="fas fa-upload"></i> Restaurar Datos</h5>
                            </div>
                            <div class="card-body text-center">
                                <p class="card-text">Restaurar datos desde un archivo Excel previamente exportado</p>
                                <div class="file-input-container btn btn-primary mb-2">
                                    <i class="fas fa-file-excel"></i> Seleccionar archivo Excel
                                    <input type="file" id="restoreFile" class="file-input" accept=".xlsx, .xls">
                                </div>
                                <div id="selectedFileName" class="text-muted mt-2">Ningún archivo seleccionado</div>
                                <button class="btn btn-warning mt-3" id="restoreData" disabled>
                                    <i class="fas fa-upload"></i> Restaurar Datos
                                </button>
                                <div class="form-check mt-3">
                                    <input class="form-check-input" type="checkbox" id="replaceData">
                                    <label class="form-check-label" for="replaceData">
                                        Reemplazar datos existentes
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0"><i class="fas fa-info-circle"></i> Información del Sistema
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="card summary-card">
                                            <div class="card-body text-center">
                                                <h5 class="card-title" id="infoUsers">0</h5>
                                                <p class="card-text">Usuarios registrados</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card summary-card">
                                            <div class="card-body text-center">
                                                <h5 class="card-title" id="infoAttendance">0</h5>
                                                <p class="card-text">Registros de asistencia</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card summary-card">
                                            <div class="card-body text-center">
                                                <h5 class="card-title" id="infoIncome">0</h5>
                                                <p class="card-text">Registros de pagos</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card summary-card">
                                            <div class="card-body text-center">
                                                <h5 class="card-title" id="infoExpenses">0</h5>
                                                <p class="card-text">Registros de gastos</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-md-3">
                                        <div class="card summary-card">
                                            <div class="card-body text-center">
                                                <h5 class="card-title" id="infoStaffClasses">0</h5>
                                                <p class="card-text">Clases de personal</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card summary-card">
                                            <div class="card-body text-center">
                                                <h5 class="card-title" id="infoTotalBalance">$0</h5>
                                                <p class="card-text">Saldo total</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card summary-card">
                                            <div class="card-body text-center">
                                                <h5 class="card-title" id="infoTrainers">0</h5>
                                                <p class="card-text">Entrenadores activos</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card summary-card">
                                            <div class="card-body text-center">
                                                <h5 class="card-title" id="infoLastBackup">Nunca</h5>
                                                <p class="card-text">Último respaldo</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="alert alert-warning mt-4">
                                    <h6><i class="fas fa-exclamation-triangle"></i> Importante</h6>
                                    <p>Los datos se almacenan localmente en su navegador. Para evitar pérdida de
                                        información:</p>
                                    <ol>
                                        <li>Realice respaldos regularmente</li>
                                        <li>Guarde los archivos de respaldo en un lugar seguro</li>
                                        <li>Si cambia de dispositivo o navegador, deberá restaurar los datos desde un
                                            archivo</li>
                                    </ol>
                                </div>

                                <div class="form-check mt-3">
                                    <input class="form-check-input" type="checkbox" id="autoBackupCheckbox">
                                    <label class="form-check-label" for="autoBackupCheckbox">
                                        Realizar respaldo automático cada 15 minutos
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>

    <!-- Notificación de respaldo automático -->
    <div class="backup-notification" id="backupNotification">
        <i class="fas fa-info-circle me-2"></i>
        <span id="backupNotificationText">Respaldo automático realizado</span>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Almacenamiento de datos
        let users = [];
        let attendance = [];
        let income = [];
        let expenses = []; // NUEVO: Array para gastos
        let staffClasses = []; // NUEVO: Array para clases de personal
        let lastBackup = 'Nunca';
        let autoBackupInterval = null;

        // Almacenamiento temporal para los datos del pago
        let pendingPaymentData = null;

        // Almacenamiento temporal para datos de importación
        let importData = {
            users: [],
            attendance: [],
            income: [],
            expenses: [], // NUEVO: Array para gastos en importación
            staffClasses: [], // NUEVO: Array para clases de personal en importación
            summary: {
                users: { success: 0, warnings: 0, errors: 0 },
                attendance: { success: 0, warnings: 0, errors: 0 },
                income: { success: 0, warnings: 0, errors: 0 },
                expenses: { success: 0, warnings: 0, errors: 0 }, // NUEVO: Resumen para gastos
                staffClasses: { success: 0, warnings: 0, errors: 0 } // NUEVO: Resumen para clases de personal
            }
        };

        // Clases disponibles
        const classTimes = ["5:00 am", "6:00 am", "7:00 am", "8:00 am", "4:00 pm", "5:30 pm", "6:30 pm", "7:30 pm"];

        // Variables para gráficos
        let affiliationChart = null;
        let attendanceChart = null;
        let incomeMonthlyChart = null;
        let financialChart = null; // NUEVO: Gráfico para reportes financieros

        // NUEVO: Valor por hora para entrenadores
        const HOURLY_RATE = 10000;

        // Inicializar la aplicación
        function initializeApp() {
            console.log("Inicializando aplicación...");

            // Cargar datos desde localStorage
            loadFromLocalStorage();
            
            // Configurar validación de teléfonos
            setupPhoneValidation();

            // Establecer fecha actual por defecto
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendanceDate').value = today;
            document.getElementById('expenseDate').value = today; // NUEVO: Fecha para gastos
            document.getElementById('classRecordDate').value = today; // NUEVO: Fecha para registro de clases

            // Establecer fechas inicial y final para pagos (hoy y 30 días después)
            document.getElementById('startDate').value = today;
            const endDate = new Date();
            endDate.setDate(endDate.getDate() + 30);
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];

            // Configurar fecha inicial para filtros (inicio del mes)
            const firstDayOfMonth = new Date();
            firstDayOfMonth.setDate(1);
            const firstDayStr = firstDayOfMonth.toISOString().split('T')[0];

            document.getElementById('attendanceStartDateFilter').value = firstDayStr;
            document.getElementById('attendanceEndDateFilter').value = today;
            document.getElementById('incomeStartDateFilter').value = firstDayStr;
            document.getElementById('incomeEndDateFilter').value = today;
            document.getElementById('expenseStartDateFilter').value = firstDayStr; // NUEVO: Filtro para gastos
            document.getElementById('expenseEndDateFilter').value = today; // NUEVO: Filtro para gastos
            document.getElementById('paymentStartDate').value = firstDayStr; // NUEVO: Filtro para pagos a entrenadores
            document.getElementById('paymentEndDate').value = today; // NUEVO: Filtro para pagos a entrenadores
            document.getElementById('historyStartDate').value = firstDayStr; // NUEVO: Filtro para historial
            document.getElementById('historyEndDate').value = today; // NUEVO: Filtro para historial

            // Establecer fechas por defecto para reportes combinados
            document.getElementById('combinedReportStartDate').value = firstDayStr;
            document.getElementById('combinedReportEndDate').value = today;

            // Establecer mes actual para reportes mensuales
            const currentMonth = new Date().toISOString().slice(0, 7);
            document.getElementById('attendanceMonth').value = currentMonth;
            document.getElementById('incomeMonth').value = currentMonth;
            document.getElementById('financialReportMonth').value = currentMonth; // NUEVO: Reporte financiero

            // Cargar datos
            loadUsers();
            loadAttendanceByClass();
            loadAttendance();
            loadIncome();
            loadExpenses(); // NUEVO: Cargar gastos
            loadStaffClasses(); // NUEVO: Cargar clases de personal
            updateSystemInfo();

            // Configurar respaldo automático si estaba activado
            if (localStorage.getItem('autoBackupEnabled') === 'true') {
                document.getElementById('autoBackupCheckbox').checked = true;
                startAutoBackup();
            }

            // Eventos para pestañas
            document.getElementById('attendance-tab').addEventListener('click', function () {
                loadAttendanceByClass();
                loadAttendance();
            });

            document.getElementById('income-tab').addEventListener('click', function () {
                loadIncome();
            });

            document.getElementById('reports-tab').addEventListener('click', function () {
                // Actualizar gráficos al cambiar a reportes
                setTimeout(() => {
                    updateCharts();
                }, 100);
            });

            // Evento para cambio de fecha inicial en pagos
            document.getElementById('startDate').addEventListener('change', function () {
                if (this.value) {
                    const startDate = new Date(this.value);
                    const endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 30);
                    document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
                }
            });
            
            // =============================================
            // EVENT LISTENERS PARA NUEVAS FUNCIONALIDADES
            // =============================================

            // NUEVO: Abrir modal de administración del dinero
            const openMoneyManagementBtn = document.getElementById('openMoneyManagementModal');
            if (openMoneyManagementBtn) {
                openMoneyManagementBtn.addEventListener('click', function() {
                    loadAccountBalances();
                    loadExpenses();
                    const moneyManagementModal = new bootstrap.Modal(document.getElementById('moneyManagementModal'));
                    moneyManagementModal.show();
                });
            }

            // NUEVO: Abrir modal de control de personal desde la pestaña de pagos
            const openStaffControlBtn = document.getElementById('openStaffControlModalFromIncome');
            if (openStaffControlBtn) {
                openStaffControlBtn.addEventListener('click', function() {
                    loadTrainers();
                    const staffControlModal = new bootstrap.Modal(document.getElementById('staffControlModal'));
                    staffControlModal.show();
                });
            }

            // NUEVO: Registrar gasto
            const expenseForm = document.getElementById('expenseForm');
            if (expenseForm) {
                expenseForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const newExpense = {
                        id: Date.now(),
                        date: document.getElementById('expenseDate').value,
                        description: document.getElementById('expenseDescription').value,
                        amount: parseFloat(document.getElementById('expenseAmount').value),
                        category: document.getElementById('expenseCategory').value,
                        account: document.getElementById('expenseAccount').value,
                        receipt: document.getElementById('expenseReceipt').value || '',
                        registeredAt: new Date().toISOString()
                    };
                    
                    expenses.push(newExpense);
                    saveToLocalStorage();
                    
                    // Actualizar vistas
                    loadExpenses();
                    loadAccountBalances();
                    updateSystemInfo();
                    
                    // Resetear formulario
                    document.getElementById('expenseForm').reset();
                    document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
                    
                    alert('Gasto registrado correctamente!');
                });
            }

            // NUEVO: Registrar clase de personal
            const registerClassForm = document.getElementById('registerClassForm');
            if (registerClassForm) {
                registerClassForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const newClassRecord = {
                        id: Date.now(),
                        date: document.getElementById('classRecordDate').value,
                        time: document.getElementById('classRecordTime').value,
                        trainerId: document.getElementById('classRecordTrainer').value,
                        classType: document.getElementById('classRecordType').value,
                        duration: parseFloat(document.getElementById('classRecordDuration').value),
                        notes: document.getElementById('classRecordNotes').value || '',
                        registeredAt: new Date().toISOString()
                    };
                    
                    staffClasses.push(newClassRecord);
                    saveToLocalStorage();
                    
                    // Actualizar vistas
                    loadStaffClasses();
                    updateSystemInfo();
                    
                    // Resetear formulario
                    document.getElementById('registerClassForm').reset();
                    document.getElementById('classRecordDate').value = new Date().toISOString().split('T')[0];
                    
                    alert('Clase registrada correctamente!');
                });
            }

            // NUEVO: Filtrar gastos
            const filterExpensesBtn = document.getElementById('filterExpensesBtn');
            if (filterExpensesBtn) {
                filterExpensesBtn.addEventListener('click', function() {
                    loadExpenses();
                });
            }

            // NUEVO: Calcular pagos a entrenadores
            const calculatePaymentsBtn = document.getElementById('calculateTrainerPayments');
            if (calculatePaymentsBtn) {
                calculatePaymentsBtn.addEventListener('click', function() {
                    calculateTrainerPayments();
                });
            }

            // NUEVO: Filtrar historial de clases
            const filterClassHistoryBtn = document.getElementById('filterClassHistory');
            if (filterClassHistoryBtn) {
                filterClassHistoryBtn.addEventListener('click', function() {
                    loadClassHistory();
                });
            }

            // NUEVO: Generar reporte financiero
            const generateFinancialReportBtn = document.getElementById('generateFinancialReport');
            if (generateFinancialReportBtn) {
                generateFinancialReportBtn.addEventListener('click', function() {
                    generateFinancialReport();
                });
            }

            // NUEVO: Exportar reporte financiero
            const exportFinancialReportBtn = document.getElementById('exportFinancialReport');
            if (exportFinancialReportBtn) {
                exportFinancialReportBtn.addEventListener('click', function() {
                    exportFinancialReport();
                });
            }

            // NUEVO: Exportar reporte de gastos
            const exportExpensesReportBtn = document.getElementById('exportExpensesReport');
            if (exportExpensesReportBtn) {
                exportExpensesReportBtn.addEventListener('click', function() {
                    exportExpensesReport();
                });
            }

            // NUEVO: Exportar reporte de pagos a entrenadores
            const exportPaymentsReportBtn = document.getElementById('exportPaymentsReport');
            if (exportPaymentsReportBtn) {
                exportPaymentsReportBtn.addEventListener('click', function() {
                    exportPaymentsReport();
                });
            }

            // NUEVO: Marcar pagos como realizados
            const markPaymentsAsPaidBtn = document.getElementById('markPaymentsAsPaid');
            if (markPaymentsAsPaidBtn) {
                markPaymentsAsPaidBtn.addEventListener('click', function() {
                    markPaymentsAsPaid();
                });
            }

            // =============================================
            // EVENT LISTENERS EXISTENTES
            // =============================================

            // Evento para respaldo automático
            const autoBackupCheckbox = document.getElementById('autoBackupCheckbox');
            if (autoBackupCheckbox) {
                autoBackupCheckbox.addEventListener('change', function () {
                    if (this.checked) {
                        startAutoBackup();
                        localStorage.setItem('autoBackupEnabled', 'true');
                    } else {
                        stopAutoBackup();
                        localStorage.setItem('autoBackupEnabled', 'false');
                    }
                });
            }

            // Evento para formulario de WhatsApp
            const openWhatsAppFormBtn = document.getElementById('openWhatsAppForm');
            if (openWhatsAppFormBtn) {
                openWhatsAppFormBtn.addEventListener('click', function () {
                    const whatsappFormModal = new bootstrap.Modal(document.getElementById('whatsappFormModal'));
                    whatsappFormModal.show();
                });
            }

            // Actualizar vista previa del formulario de WhatsApp
            const clientNameInput = document.getElementById('clientName');
            const clientPhoneInput = document.getElementById('clientPhone');
            const whatsappGroupLinkInput = document.getElementById('whatsappGroupLink');
            const includeGroupLinkCheck = document.getElementById('includeGroupLink');
            const includeGoogleFormCheck = document.getElementById('includeGoogleForm');

            if (clientNameInput) clientNameInput.addEventListener('input', updateWhatsAppFormPreview);
            if (clientPhoneInput) clientPhoneInput.addEventListener('input', updateWhatsAppFormPreview);
            if (whatsappGroupLinkInput) whatsappGroupLinkInput.addEventListener('input', updateWhatsAppFormPreview);
            if (includeGroupLinkCheck) includeGroupLinkCheck.addEventListener('change', updateWhatsAppFormPreview);
            if (includeGoogleFormCheck) includeGoogleFormCheck.addEventListener('change', updateWhatsAppFormPreview);

            // Configurar envío de confirmación de pago
            const sendConfirmationBtn = document.getElementById('sendConfirmationBtn');
            if (sendConfirmationBtn) {
                sendConfirmationBtn.addEventListener('click', function () {
                    if (!pendingPaymentData) {
                        alert('No hay datos de pago pendientes.');
                        return;
                    }

                    // Registrar el pago ahora
                    pendingPaymentData.id = Date.now();
                    income.push(pendingPaymentData);
                    saveToLocalStorage();

                    // Recargar la lista de ingresos
                    loadIncome();

                    // Obtener el usuario para el mensaje de WhatsApp
                    const selectedUser = users.find(u => u.id === pendingPaymentData.userId);

                    if (selectedUser) {
                        // Validar teléfono
                        if (!isValidPhone(selectedUser.phone)) {
                            alert('No se puede enviar el mensaje porque el usuario no tiene un número de teléfono válido.');

                            // Cerrar modal de confirmación
                            const paymentModal = bootstrap.Modal.getInstance(document.getElementById('paymentConfirmationModal'));
                            if (paymentModal) paymentModal.hide();

                            // Limpiar datos pendientes
                            pendingPaymentData = null;
                            return;
                        }

                        // MODIFICACIÓN 1: Formatear monto sin decimales y corregir fecha
                        const amountFormatted = parseInt(pendingPaymentData.amount).toLocaleString('es-ES');
                        
                        // MODIFICACIÓN 1: Corregir fecha que retrocede un día
                        const endDateFormatted = formatDateForWhatsApp(pendingPaymentData.endDate);
                        
                        // Preparar y enviar mensaje de WhatsApp
                        const message = `Hola ${selectedUser.name}, tu pago en Antologia Box23 por un valor de $${amountFormatted} por ${pendingPaymentData.paymentType} ha sido registrado exitosamente. Tu membresía es válida hasta el ${endDateFormatted}. ¡Gracias por confiar en Antología Box23!`;

                        // Usar la función sendWhatsApp
                        sendWhatsApp(selectedUser.id, amountFormatted, endDateFormatted);
                    } else {
                        alert('No se puede enviar el mensaje porque no se encontró el usuario seleccionado.');
                    }

                    // Cerrar modal de confirmación
                    const paymentModal = bootstrap.Modal.getInstance(document.getElementById('paymentConfirmationModal'));
                    if (paymentModal) paymentModal.hide();

                    // Resetear el formulario
                    document.getElementById('incomeForm').reset();

                    // Restablecer fechas por defecto
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('startDate').value = today;
                    const endDate = new Date();
                    endDate.setDate(endDate.getDate() + 30);
                    document.getElementById('endDate').value = endDate.toISOString().split('T')[0];

                    // Limpiar datos pendientes
                    pendingPaymentData = null;
                });
            }

            // También debemos manejar el caso en que el usuario cancele el envío del mensaje
            const paymentConfirmationModal = document.getElementById('paymentConfirmationModal');
            if (paymentConfirmationModal) {
                paymentConfirmationModal.addEventListener('hidden.bs.modal', function () {
                    // Si hay datos pendientes pero no se envió el mensaje, preguntar si se desea guardar igualmente
                    if (pendingPaymentData) {
                        if (confirm('¿Desea registrar el pago sin enviar el mensaje de WhatsApp?')) {
                            // Registrar el pago
                            pendingPaymentData.id = Date.now();
                            income.push(pendingPaymentData);
                            saveToLocalStorage();

                            // Recargar la lista de ingresos
                            loadIncome();

                            // Resetear el formulario
                            document.getElementById('incomeForm').reset();

                            // Restablecer fechas por defecto
                            const today = new Date().toISOString().split('T')[0];
                            document.getElementById('startDate').value = today;
                            const endDate = new Date();
                            endDate.setDate(endDate.getDate() + 30);
                            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
                        }

                        // Limpiar datos pendientes
                        pendingPaymentData = null;
                    }
                });
            }

            // Eventos para WhatsApp
            const whatsappNumberInput = document.getElementById('whatsappNumber');
            const whatsappMessageInput = document.getElementById('whatsappMessage');
            
            if (whatsappNumberInput) {
                whatsappNumberInput.addEventListener('input', function () {
                    if (this.value && !isValidPhone(this.value)) {
                        document.getElementById('whatsappPhoneError').style.display = 'block';
                        this.classList.add('validation-error');
                    } else {
                        document.getElementById('whatsappPhoneError').style.display = 'none';
                        this.classList.remove('validation-error');
                    }
                    updateWhatsAppLink();
                });
            }

            if (whatsappMessageInput) {
                whatsappMessageInput.addEventListener('input', function () {
                    document.getElementById('messagePreview').textContent = this.value;
                    updateWhatsAppLink();
                });
            }

            // Configurar eventos de filtrado
            const filterAttendanceBtn = document.getElementById('filterAttendanceBtn');
            const filterIncomeBtn = document.getElementById('filterIncomeBtn');
            
            if (filterAttendanceBtn) filterAttendanceBtn.addEventListener('click', loadAttendance);
            if (filterIncomeBtn) filterIncomeBtn.addEventListener('click', loadIncome);

            // Configurar búsqueda de usuarios
            const searchUserInput = document.getElementById('searchUserInput');
            if (searchUserInput) {
                searchUserInput.addEventListener('input', filterUsers);
            }

            // MEJORA 1: Configurar búsqueda en tablas
            const attendanceTableSearch = document.getElementById('attendanceTableSearch');
            const incomeTableSearch = document.getElementById('incomeTableSearch');
            
            if (attendanceTableSearch) attendanceTableSearch.addEventListener('input', filterAttendanceTable);
            if (incomeTableSearch) incomeTableSearch.addEventListener('input', filterIncomeTable);

            // Configurar evento antes de cerrar la ventana
            window.addEventListener('beforeunload', function (e) {
                if (localStorage.getItem('autoBackupEnabled') === 'true') {
                    createAutoBackup();
                    // Mensaje de confirmación personalizado no es posible en todos los navegadores
                    e.preventDefault();
                    e.returnValue = '¿Estás seguro de que quieres salir? Se realizará un respaldo automático de tus datos.';
                }
            });

            // Eventos para la nueva sección de asistencias
            const refreshAttendanceBtn = document.getElementById('refreshAttendance');
            if (refreshAttendanceBtn) {
                refreshAttendanceBtn.addEventListener('click', function () {
                    loadAttendanceByClass();
                });
            }

            const markAllPresentBtn = document.getElementById('markAllPresent');
            if (markAllPresentBtn) {
                markAllPresentBtn.addEventListener('click', function () {
                    const checkboxes = document.querySelectorAll('.attendance-checkbox');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = true;
                    });
                    updateAttendanceStats();
                });
            }

            const clearAllAttendanceBtn = document.getElementById('clearAllAttendance');
            if (clearAllAttendanceBtn) {
                clearAllAttendanceBtn.addEventListener('click', function () {
                    const checkboxes = document.querySelectorAll('.attendance-checkbox');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    updateAttendanceStats();
                });
            }

            const attendanceDateInput = document.getElementById('attendanceDate');
            if (attendanceDateInput) {
                attendanceDateInput.addEventListener('change', function () {
                    loadAttendanceByClass();
                });
            }

            // NUEVO: Evento para el buscador de asistencia
            const attendanceSearchInput = document.getElementById('attendanceSearchInput');
            if (attendanceSearchInput) {
                attendanceSearchInput.addEventListener('input', filterAttendanceUsers);
            }

            // Evento para confirmar importación
            const confirmImportBtn = document.getElementById('confirmImportBtn');
            if (confirmImportBtn) {
                confirmImportBtn.addEventListener('click', function () {
                    confirmImport();
                });
            }

            // Evento para restaurar datos
            const restoreDataBtn = document.getElementById('restoreData');
            if (restoreDataBtn) {
                restoreDataBtn.addEventListener('click', function () {
                    // El preprocesamiento ya se hizo al seleccionar el archivo
                    // Solo necesitamos asegurarnos de que hay datos para importar
                    if (importData.users.length === 0 &&
                        importData.attendance.length === 0 &&
                        importData.income.length === 0 &&
                        importData.expenses.length === 0 &&
                        importData.staffClasses.length === 0) {
                        alert('No hay datos válidos para importar.');
                        return;
                    }

                    // El modal de resumen ya se muestra en preprocessImportData
                });
            }

            // Evento para exportar a Excel
            const exportBtn = document.getElementById('exportBtn');
            if (exportBtn) {
                exportBtn.addEventListener('click', function () {
                    // Preparar datos para exportar
                    let workbook = XLSX.utils.book_new();

                    // Hoja de usuarios
                    const usersData = users.map(user => ({
                        'ID': user.id,
                        'Nombre': user.name,
                        'Documento': user.document || '',
                        'Fecha Nacimiento': user.birthdate || '',
                        'Telefono': user.phone ? `'${user.phone}` : '', // Prefijar con ' para mantener formato texto
                        'EPS': user.eps || '',
                        'RH': user.rh || '',
                        'Patologia': user.pathology || '',
                        'Contacto Emergencia': user.emergencyContact || '',
                        'Telefono Emergencia': user.emergencyPhone ? `'${user.emergencyPhone}` : '',
                        'Clase': user.classTime || '',
                        'Tipo Afiliacion': user.affiliationType || '',
                        'Estado': user.status || '',
                        'Fecha Registro': user.createdAt ? new Date(user.createdAt).toLocaleDateString('es-ES') : ''
                    }));

                    const usersWorksheet = XLSX.utils.json_to_sheet(usersData);
                    XLSX.utils.book_append_sheet(workbook, usersWorksheet, 'Usuarios');

                    // Generar archivo Excel
                    const fileName = `reporte_antologia_${new Date().toISOString().split('T')[0]}.xlsx`;
                    XLSX.writeFile(workbook, fileName);

                    alert(`Reporte exportado correctamente como ${fileName}`);
                });
            }

            // Evento para respaldo de datos
            const backupDataBtn = document.getElementById('backupData');
            if (backupDataBtn) {
                backupDataBtn.addEventListener('click', function () {
                    if (confirm('¿Está seguro de que desea descargar un respaldo completo de todos los datos?')) {
                        // Crear un libro de trabajo con todas las hojas
                        let workbook = XLSX.utils.book_new();

                        // Hoja de usuarios - CON NOMBRES CORRECTOS
                        const usersData = users.map(user => ({
                            'ID': user.id,
                            'Nombre': user.name,
                            'Documento': user.document || '',
                            'Fecha Nacimiento': user.birthdate || '',
                            'Telefono': user.phone ? `'${user.phone}` : '', // Prefijar con ' para mantener formato texto
                            'EPS': user.eps || '',
                            'RH': user.rh || '',
                            'Patologia': user.pathology || '',
                            'Contacto Emergencia': user.emergencyContact || '',
                            'Telefono Emergencia': user.emergencyPhone ? `'${user.emergencyPhone}` : '',
                            'Clase': user.classTime || '',
                            'Tipo Afiliacion': user.affiliationType || '',
                            'Estado': user.status || '',
                            'Fecha Registro': user.createdAt ? new Date(user.createdAt).toLocaleDateString('es-ES') : ''
                        }));

                        const usersWorksheet = XLSX.utils.json_to_sheet(usersData);
                        XLSX.utils.book_append_sheet(workbook, usersWorksheet, 'Usuarios');

                        // Hoja de asistencias - CON NOMBRES CORRECTOS
                        const attendanceData = attendance.map(record => {
                            const user = users.find(u => u.id === record.userId) || { name: 'Usuario eliminado' };
                            return {
                                'ID': record.id,
                                'UsuarioID': record.userId,
                                'Fecha': record.date,
                                'Usuario': user.name,
                                'Estado': record.status,
                                'Fecha Registro': record.registeredAt ? new Date(record.registeredAt).toLocaleDateString('es-ES') : ''
                            };
                        });

                        const attendanceWorksheet = XLSX.utils.json_to_sheet(attendanceData);
                        XLSX.utils.book_append_sheet(workbook, attendanceWorksheet, 'Asistencias');

                        // Hoja de pagos - CON NOMBRES CORRECTOS
                        const incomeData = income.map(record => {
                            const user = users.find(u => u.id === record.userId) || { name: 'Usuario eliminado' };
                            return {
                                'ID': record.id,
                                'UsuarioID': record.userId,
                                'Fecha Pago': record.paymentDate,
                                'Fecha Inicio': record.startDate,
                                'Fecha Fin': record.endDate,
                                'Usuario': user.name,
                                'Monto': parseFloat(record.amount || 0),
                                'Tipo Pago': record.paymentType || '',
                                'Cuenta': record.account || '',
                                'Descripción': record.description || '',
                                'Fecha Registro': record.registeredAt ? new Date(record.registeredAt).toLocaleDateString('es-ES') : ''
                            };
                        });

                        const incomeWorksheet = XLSX.utils.json_to_sheet(incomeData);
                        XLSX.utils.book_append_sheet(workbook, incomeWorksheet, 'Pagos');

                        // NUEVO: Hoja de gastos
                        const expensesData = expenses.map(expense => ({
                            'ID': expense.id,
                            'Fecha': expense.date,
                            'Descripción': expense.description || '',
                            'Monto': parseFloat(expense.amount || 0),
                            'Categoría': expense.category || '',
                            'Cuenta': expense.account || '',
                            'Factura': expense.receipt || '',
                            'Fecha Registro': expense.registeredAt ? new Date(expense.registeredAt).toLocaleDateString('es-ES') : ''
                        }));

                        const expensesWorksheet = XLSX.utils.json_to_sheet(expensesData);
                        XLSX.utils.book_append_sheet(workbook, expensesWorksheet, 'Gastos');

                        // NUEVO: Hoja de clases de personal
                        const staffClassesData = staffClasses.map(record => {
                            const trainer = users.find(u => u.id === record.trainerId) || { name: 'Entrenador no encontrado' };
                            return {
                                'ID': record.id,
                                'Fecha': record.date,
                                'Hora': record.time,
                                'EntrenadorID': record.trainerId,
                                'Entrenador': trainer.name,
                                'Tipo Clase': record.classType || '',
                                'Duración': record.duration || 1,
                                'Notas': record.notes || '',
                                'Fecha Registro': record.registeredAt ? new Date(record.registeredAt).toLocaleDateString('es-ES') : ''
                            };
                        });

                        const staffClassesWorksheet = XLSX.utils.json_to_sheet(staffClassesData);
                        XLSX.utils.book_append_sheet(workbook, staffClassesWorksheet, 'Clases Personal');

                        // Hoja de metadatos
                        const metadata = [
                            { 'Tipo': 'Sistema', 'Valor': 'Antología Box23 - Sistema de Gestión', 'Fecha': new Date().toLocaleDateString('es-ES') },
                            { 'Tipo': 'Fecha respaldo', 'Valor': new Date().toLocaleString('es-ES'), 'Fecha': new Date().toLocaleDateString('es-ES') },
                            { 'Tipo': 'Total usuarios', 'Valor': users.length, 'Fecha': new Date().toLocaleDateString('es-ES') },
                            { 'Tipo': 'Total asistencias', 'Valor': attendance.length, 'Fecha': new Date().toLocaleDateString('es-ES') },
                            { 'Tipo': 'Total pagos', 'Valor': income.length, 'Fecha': new Date().toLocaleDateString('es-ES') },
                            { 'Tipo': 'Total gastos', 'Valor': expenses.length, 'Fecha': new Date().toLocaleDateString('es-ES') },
                            { 'Tipo': 'Total clases personal', 'Valor': staffClasses.length, 'Fecha': new Date().toLocaleDateString('es-ES') }
                        ];

                        const metadataWorksheet = XLSX.utils.json_to_sheet(metadata);
                        XLSX.utils.book_append_sheet(workbook, metadataWorksheet, 'Metadatos');

                        // Generar archivo Excel
                        const fileName = `respaldo_antologia_${new Date().toISOString().split('T')[0]}.xlsx`;
                        XLSX.writeFile(workbook, fileName);

                        // Actualizar última fecha de respaldo
                        lastBackup = new Date().toLocaleString('es-ES');
                        localStorage.setItem('lastBackup', lastBackup);
                        updateSystemInfo();

                        alert(`Respaldo completo guardado como ${fileName}`);
                    }
                });
            }

            // Evento para restaurar automáticamente
            const restoreAutoBtn = document.getElementById('restoreAutoBtn');
            if (restoreAutoBtn) {
                restoreAutoBtn.addEventListener('click', function () {
                    // Restaurar desde el respaldo automático
                    const backupKey = 'gymSystemBackup';
                    const autoBackup = localStorage.getItem(backupKey);

                    if (autoBackup) {
                        try {
                            const backupData = JSON.parse(autoBackup);

                            // Verificar que backupData tenga la estructura esperada
                            if (backupData.users && backupData.attendance && backupData.income) {
                                // Restaurar automáticamente
                                users = backupData.users || [];
                                attendance = backupData.attendance || [];
                                income = backupData.income || [];
                                expenses = backupData.expenses || [];
                                staffClasses = backupData.staffClasses || [];

                                saveToLocalStorage();

                                loadUsers();
                                loadAttendanceByClass();
                                loadAttendance();
                                loadIncome();
                                loadExpenses();
                                loadStaffClasses();
                                updateSystemInfo();

                                alert('Datos restaurados correctamente desde el respaldo automático.');
                            } else {
                                console.error('Estructura de respaldo automático inválida');
                                alert('El respaldo automático no tiene la estructura correcta.');
                            }
                        } catch (e) {
                            console.error('Error al analizar el respaldo automático:', e);
                            alert('Error al restaurar desde el respaldo automático.');
                        }
                    }

                    // Ocultar sección de restauración automática
                    document.getElementById('autorestoreSection').classList.add('d-none');
                });
            }

            // Evento para saltar restauración automática
            const skipRestoreBtn = document.getElementById('skipRestoreBtn');
            if (skipRestoreBtn) {
                skipRestoreBtn.addEventListener('click', function () {
                    // Ocultar sección de restauración automática
                    document.getElementById('autorestoreSection').classList.add('d-none');
                });
            }

            // Evento para selección de archivo de restauración
            const restoreFileInput = document.getElementById('restoreFile');
            if (restoreFileInput) {
                restoreFileInput.addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (file) {
                        document.getElementById('selectedFileName').textContent = file.name;
                        document.getElementById('restoreData').disabled = false;

                        // Leer el archivo inmediatamente para preprocesar
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            try {
                                const data = new Uint8Array(e.target.result);
                                const workbook = XLSX.read(data, { type: 'array' });

                                // Verificar que el archivo tenga las hojas necesarias
                                const requiredSheets = ['Usuarios', 'Asistencias', 'Pagos'];
                                const hasRequiredSheets = requiredSheets.every(sheet => 
                                    workbook.SheetNames.includes(sheet)
                                );

                                if (!hasRequiredSheets) {
                                    alert('El archivo seleccionado no es un respaldo válido del sistema.');
                                    document.getElementById('restoreData').disabled = true;
                                    return;
                                }

                                // Preprocesar datos para mostrar resumen
                                preprocessImportData(workbook);

                            } catch (error) {
                                console.error('Error al leer el archivo:', error);
                                alert('Error al leer el archivo. Asegúrese de que es un archivo Excel válido.');
                                document.getElementById('restoreData').disabled = true;
                            }
                        };
                        reader.readAsArrayBuffer(file);
                    } else {
                        document.getElementById('selectedFileName').textContent = 'Ningún archivo seleccionado';
                        document.getElementById('restoreData').disabled = true;
                    }
                });
            }

            // Evento para formulario de usuario
            const userForm = document.getElementById('userForm');
            if (userForm) {
                userForm.addEventListener('submit', function (e) {
                    e.preventDefault();

                    // Validar teléfonos
                    const phone = document.getElementById('phone').value;
                    const emergencyPhone = document.getElementById('emergencyPhone').value;

                    if (!isValidPhone(phone)) {
                        alert('El formato del teléfono principal es inválido. Debe tener 10 dígitos y comenzar con 3.');
                        return;
                    }

                    if (!isValidPhone(emergencyPhone)) {
                        alert('El formato del teléfono de emergencia es inválido. Debe tener 10 dígitos y comenzar con 3.');
                        return;
                    }

                    const newUser = {
                        id: generateNextUserId(),
                        name: document.getElementById('name').value,
                        document: document.getElementById('document').value,
                        birthdate: document.getElementById('birthdate').value,
                        phone: phone,
                        eps: document.getElementById('eps').value,
                        rh: document.getElementById('rh').value,
                        pathology: document.getElementById('pathology').value,
                        emergencyContact: document.getElementById('emergencyContact').value,
                        emergencyPhone: emergencyPhone,
                        classTime: document.getElementById('classTime').value,
                        affiliationType: document.getElementById('affiliationType').value,
                        status: document.getElementById('status').value,
                        createdAt: new Date().toISOString()
                    };

                    users.push(newUser);
                    saveToLocalStorage();

                    loadUsers();
                    document.getElementById('userForm').reset();

                    // Mostrar mensaje de éxito
                    alert('Usuario registrado correctamente!');
                });
            }

            // Evento para formulario de ingresos (MODIFICADO para incluir cuenta)
            const incomeForm = document.getElementById('incomeForm');
            if (incomeForm) {
                incomeForm.addEventListener('submit', function (e) {
                    e.preventDefault();

                    // Recoger los datos del formulario pero no guardarlos todavía
                    pendingPaymentData = {
                        userId: document.getElementById('incomeUserSelect').value,
                        paymentDate: new Date().toISOString().split('T')[0],
                        startDate: document.getElementById('startDate').value,
                        endDate: document.getElementById('endDate').value,
                        paymentType: document.getElementById('paymentType').value,
                        account: document.getElementById('paymentAccount').value, // NUEVO: Cuenta
                        amount: parseFloat(document.getElementById('amount').value).toFixed(2),
                        description: document.getElementById('description').value,
                        registeredAt: new Date().toISOString()
                    };

                    // Validar que se haya seleccionado un usuario
                    if (!pendingPaymentData.userId) {
                        alert('Por favor, seleccione un usuario.');
                        return;
                    }

                    // Validar que se haya seleccionado una cuenta
                    if (!pendingPaymentData.account) {
                        alert('Por favor, seleccione una cuenta.');
                        return;
                    }

                    // Mostrar modal de confirmación en lugar de registrar inmediatamente
                    const paymentModal = new bootstrap.Modal(document.getElementById('paymentConfirmationModal'));
                    paymentModal.show();
                });
            }

            // Evento para guardar asistencias
            const saveAttendanceBtn = document.getElementById('saveAttendance');
            if (saveAttendanceBtn) {
                saveAttendanceBtn.addEventListener('click', function () {
                    const attendanceDate = document.getElementById('attendanceDate').value;
                    const checkboxes = document.querySelectorAll('.attendance-checkbox');
                    let savedCount = 0;

                    // Eliminar asistencias previas para esta fecha
                    attendance = attendance.filter(a => a.date !== attendanceDate);

                    checkboxes.forEach(checkbox => {
                        const userId = checkbox.dataset.userId;
                        const isPresent = checkbox.checked;

                        if (isPresent) {
                            attendance.push({
                                id: Date.now() + savedCount,
                                userId: userId,
                                date: attendanceDate,
                                status: 'presente',
                                registeredAt: new Date().toISOString()
                            });
                            savedCount++;
                        }
                    });

                    saveToLocalStorage();
                    loadAttendanceByClass();
                    loadAttendance();
                    updateSystemInfo();

                    alert(`Asistencias guardadas correctamente. Total: ${savedCount}`);
                });
            }

            // Evento para mostrar cumpleaños del mes
            const showBirthdaysBtn = document.getElementById('showBirthdaysThisMonth');
            if (showBirthdaysBtn) {
                showBirthdaysBtn.addEventListener('click', function () {
                    showBirthdays('month');
                });
            }

            // Evento para enviar felicitaciones de cumpleaños
            const sendBirthdayWishesBtn = document.getElementById('sendBirthdayWishes');
            if (sendBirthdayWishesBtn) {
                sendBirthdayWishesBtn.addEventListener('click', function () {
                    sendBirthdayWishes();
                });
            }

            // NUEVOS EVENTOS PARA REPORTES MEJORADOS
            const generateAttendanceReportBtn = document.getElementById('generateAttendanceReport');
            const generateIncomeReportBtn = document.getElementById('generateIncomeReport');
            const exportAttendanceReportBtn = document.getElementById('exportAttendanceReport');
            const exportIncomeReportBtn = document.getElementById('exportIncomeReport');

            if (generateAttendanceReportBtn) generateAttendanceReportBtn.addEventListener('click', function() {
                generateAttendanceMonthlyReport();
            });

            if (generateIncomeReportBtn) generateIncomeReportBtn.addEventListener('click', function() {
                generateIncomeMonthlyReport();
            });

            if (exportAttendanceReportBtn) exportAttendanceReportBtn.addEventListener('click', function() {
                exportAttendanceReport();
            });

            if (exportIncomeReportBtn) exportIncomeReportBtn.addEventListener('click', function() {
                exportIncomeReport();
            });

            // NUEVO: Eventos para reporte combinado
            const generateCombinedReportBtn = document.getElementById('generateCombinedReport');
            const exportCombinedReportBtn = document.getElementById('exportCombinedReport');

            if (generateCombinedReportBtn) generateCombinedReportBtn.addEventListener('click', function() {
                generateCombinedReport();
            });

            if (exportCombinedReportBtn) exportCombinedReportBtn.addEventListener('click', function() {
                exportCombinedReport();
            });

            console.log("Aplicación inicializada correctamente");
        }

        // =============================================
        // FUNCIONES PRINCIPALES - CORREGIDAS
        // =============================================

        // Función para cargar datos desde localStorage (ACTUALIZADA Y CORREGIDA)
        function loadFromLocalStorage() {
            try {
                const usersData = localStorage.getItem('users');
                const attendanceData = localStorage.getItem('attendance');
                const incomeData = localStorage.getItem('income');
                const expensesData = localStorage.getItem('expenses');
                const staffClassesData = localStorage.getItem('staffClasses');
                const lastBackupData = localStorage.getItem('lastBackup');

                users = usersData ? JSON.parse(usersData) : [];
                attendance = attendanceData ? JSON.parse(attendanceData) : [];
                income = incomeData ? JSON.parse(incomeData) : [];
                expenses = expensesData ? JSON.parse(expensesData) : [];
                staffClasses = staffClassesData ? JSON.parse(staffClassesData) : [];
                lastBackup = lastBackupData || 'Nunca';

                console.log("Datos cargados desde localStorage:", {
                    users: users.length,
                    attendance: attendance.length,
                    income: income.length,
                    expenses: expenses.length,
                    staffClasses: staffClasses.length
                });
            } catch (error) {
                console.error("Error al cargar datos desde localStorage:", error);
                // Inicializar con arrays vacíos si hay error
                users = [];
                attendance = [];
                income = [];
                expenses = [];
                staffClasses = [];
                lastBackup = 'Nunca';
                
                // Mostrar mensaje de advertencia
                console.warn("No se pudieron cargar datos previos. Iniciando con datos nuevos.");
            }
        }

        // Función para guardar datos en localStorage (ACTUALIZADA Y CORREGIDA)
        function saveToLocalStorage() {
            try {
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('attendance', JSON.stringify(attendance));
                localStorage.setItem('income', JSON.stringify(income));
                localStorage.setItem('expenses', JSON.stringify(expenses));
                localStorage.setItem('staffClasses', JSON.stringify(staffClasses));
                localStorage.setItem('lastBackup', lastBackup);

                console.log("Datos guardados en localStorage correctamente");

            } catch (error) {
                console.error("Error al guardar datos en localStorage:", error);
                alert("Error al guardar datos. Verifique que el almacenamiento local no esté lleno o habilitado.");
            }
        }

        // Función para generar ID consecutivo ATG0001
        function generateNextUserId() {
            // Obtener el último ID utilizado
            let lastId = parseInt(localStorage.getItem('lastUserId')) || 0;

            // Buscar el máximo ID en los usuarios existentes
            if (users.length > 0) {
                const maxId = Math.max(...users.map(user => {
                    if (user.id && user.id.startsWith('ATG')) {
                        const idNum = parseInt(user.id.substring(3));
                        return isNaN(idNum) ? 0 : idNum;
                    }
                    return 0;
                }));
                lastId = Math.max(lastId, maxId);
            }

            // Generar nuevo ID
            const newId = lastId + 1;
            localStorage.setItem('lastUserId', newId);
            return 'ATG' + newId.toString().padStart(4, '0');
        }

        // Función para validar número de teléfono
        function isValidPhone(phone) {
            if (!phone) return false;
            // Eliminar espacios, guiones y paréntesis
            const cleaned = phone.replace(/\D/g, '');
            // Validar que tenga 10 dígitos y empiece con 3
            return cleaned.length === 10 && cleaned.startsWith('3');
        }

        // Función para limpiar número de teléfono
        function cleanPhone(phone) {
            if (!phone) return '';
            return phone.replace(/\D/g, '');
        }

        // Función para formatear números de teléfono
        function formatPhone(phone) {
            if (!phone) return '';

            // Convertir a string y eliminar caracteres no numéricos
            const phoneStr = String(phone).replace(/\D/g, '');

            // Si tiene 10 dígitos, formatear como número colombiano
            if (phoneStr.length === 10) {
                return phoneStr;
            }

            // Devolver el valor original si no cumple con el formato
            return phoneStr;
        }

        // MODIFICACIÓN 1: Función para formatear fecha correctamente para WhatsApp
        function formatDateForWhatsApp(dateString) {
            if (!dateString) return '';
            
            // Crear fecha y asegurar que no se reste un día por zona horaria
            const date = new Date(dateString);
            // Agregar un día para compensar el desfase de zona horaria
            date.setDate(date.getDate() + 1);
            
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            return date.toLocaleDateString('es-ES', options);
        }

        // Función mejorada para convertir fechas al formato correcto
        function convertToISODate(dateValue) {
            if (!dateValue) return null;

            // Si es un número (serial de Excel), convertirlo a fecha
            if (typeof dateValue === 'number') {
                const excelEpoch = new Date(1899, 11, 30);
                const date = new Date(excelEpoch.getTime() + dateValue * 24 * 60 * 60 * 1000);
                return date.toISOString().split('T')[0];
            }

            // Si ya es una fecha en formato ISO (YYYY-MM-DD)
            if (typeof dateValue === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateValue)) {
                return dateValue;
            }

            // Si es una fecha en formato local (DD/MM/YYYY)
            if (typeof dateValue === 'string' && /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateValue)) {
                const parts = dateValue.split('/');
                const day = parts[0].padStart(2, '0');
                const month = parts[1].padStart(2, '0');
                const year = parts[2];
                return `${year}-${month}-${day}`;
            }

            // Si es un objeto Date
            if (dateValue instanceof Date) {
                return dateValue.toISOString().split('T')[0];
            }

            // Si no se puede parsear, devolver null
            return null;
        }

        // Validar formato de teléfono en tiempo real
        function setupPhoneValidation() {
            const phoneInputs = [
                { id: 'phone', errorId: 'phoneError' },
                { id: 'emergencyPhone', errorId: 'emergencyPhoneError' },
                { id: 'editPhone', errorId: 'editPhoneError' },
                { id: 'editEmergencyPhone', errorId: 'editEmergencyPhoneError' },
                { id: 'clientPhone', errorId: 'clientPhoneError' },
                { id: 'whatsappNumber', errorId: 'whatsappPhoneError' }
            ];

            phoneInputs.forEach(({ id, errorId }) => {
                const input = document.getElementById(id);
                const error = document.getElementById(errorId);

                if (input && error) {
                    input.addEventListener('input', function () {
                        if (this.value && !isValidPhone(this.value)) {
                            error.style.display = 'block';
                            this.classList.add('validation-error');
                        } else {
                            error.style.display = 'none';
                            this.classList.remove('validation-error');
                        }
                    });

                    input.addEventListener('blur', function () {
                        if (this.value && !isValidPhone(this.value)) {
                            error.style.display = 'block';
                            this.classList.add('validation-error');
                        }
                    });
                }
            });
        }

        // MEJORA 1: Función para filtrar tabla de asistencias
        function filterAttendanceTable() {
            const attendanceTableSearch = document.getElementById('attendanceTableSearch');
            if (!attendanceTableSearch) return;
            
            const searchText = attendanceTableSearch.value.toLowerCase();
            const rows = document.querySelectorAll('#attendanceTable tbody tr');
            
            rows.forEach(row => {
                const userName = row.cells[1].textContent.toLowerCase();
                const userClass = row.cells[2].textContent.toLowerCase();
                const userStatus = row.cells[3].textContent.toLowerCase();
                
                if (userName.includes(searchText) || userClass.includes(searchText) || userStatus.includes(searchText)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // MEJORA 1: Función para filtrar tabla de pagos
        function filterIncomeTable() {
            const incomeTableSearch = document.getElementById('incomeTableSearch');
            if (!incomeTableSearch) return;
            
            const searchText = incomeTableSearch.value.toLowerCase();
            const rows = document.querySelectorAll('#incomeTable tbody tr');
            
            rows.forEach(row => {
                const userName = row.cells[1].textContent.toLowerCase();
                const paymentType = row.cells[3].textContent.toLowerCase();
                const description = row.cells[6].textContent.toLowerCase();
                
                if (userName.includes(searchText) || paymentType.includes(searchText) || description.includes(searchText)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Enviar mensaje por WhatsApp
        function sendWhatsApp(userId, amount, endDate) {
            const user = users.find(u => u.id == userId);
            if (!user) return;

            // Validar teléfono
            if (!isValidPhone(user.phone)) {
                alert('El usuario no tiene un número de teléfono válido. Por favor, edite el usuario y agregue un número válido de 10 dígitos que comience con 3.');
                return;
            }

            // Rellenar el formulario de WhatsApp
            document.getElementById('whatsappNumber').value = cleanPhone(user.phone);

            // MODIFICACIÓN 1: Crear mensaje predeterminado con formato corregido
            const message = `Hola ${user.name}, tu pago en Antologia Box23 por un valor de *_$${amount}_* ha sido registrado.
            
            Tu membresía es válida hasta el *_${endDate}_*. ¡Gracias por tu preferencia!`;
            document.getElementById('whatsappMessage').value = message;
            document.getElementById('messagePreview').textContent = message;

            // Actualizar enlace de WhatsApp
            updateWhatsAppLink();

            // Mostrar modal
            const whatsappModal = new bootstrap.Modal(document.getElementById('whatsappModal'));
            whatsappModal.show();
        }

        // Actualizar enlace de WhatsApp
        function updateWhatsAppLink() {
            const phone = cleanPhone(document.getElementById('whatsappNumber').value);
            const message = document.getElementById('whatsappMessage').value;

            if (phone && message) {
                const encodedMessage = encodeURIComponent(message);
                document.getElementById('whatsappLink').href = `https://wa.me/57${phone}?text=${encodedMessage}`;
            }
        }

        // Filtrar usuarios en la tabla
        function filterUsers() {
            const searchText = document.getElementById('searchUserInput').value.toLowerCase();
            const userRows = document.querySelectorAll('#usersList tr');

            userRows.forEach(row => {
                const name = row.cells[1].textContent.toLowerCase();
                const document = row.cells[2].textContent.toLowerCase();
                const phone = row.cells[3].textContent.toLowerCase();

                if (name.includes(searchText) || document.includes(searchText) || phone.includes(searchText)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // NUEVA: Función para filtrar usuarios en la lista de asistencia
        function filterAttendanceUsers() {
            const attendanceSearchInput = document.getElementById('attendanceSearchInput');
            if (!attendanceSearchInput) return;
            
            const searchText = attendanceSearchInput.value.toLowerCase();
            const userItems = document.querySelectorAll('.attendance-user-item');

            userItems.forEach(item => {
                const userName = item.querySelector('.attendance-user-name').textContent.toLowerCase();
                if (userName.includes(searchText)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Formatear fecha a formato legible
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            return date.toLocaleDateString('es-ES', options);
        }

        // Verificar si existe un archivo de respaldo automático
        function checkAutoBackup() {
            // Verificar si hay datos en localStorage primero
            if (users.length === 0 && attendance.length === 0 && income.length === 0 && expenses.length === 0 && staffClasses.length === 0) {
                // Buscar archivo de respaldo automático
                const backupKey = 'gymSystemBackup';
                const autoBackup = localStorage.getItem(backupKey);

                if (autoBackup) {
                    try {
                        const backupData = JSON.parse(autoBackup);

                        // Verificar que backupData tenga la estructura esperada
                        if (backupData.users && backupData.attendance && backupData.income) {
                            // Mostrar sección de restauración automática
                            const autorestoreSection = document.getElementById('autorestoreSection');
                            if (autorestoreSection) {
                                autorestoreSection.classList.remove('d-none');
                            }
                        }
                    } catch (e) {
                        console.error('Error al analizar el respaldo automático:', e);
                    }
                }
            }
        }

        // Iniciar respaldo automático
        function startAutoBackup() {
            if (autoBackupInterval) {
                clearInterval(autoBackupInterval);
            }

            autoBackupInterval = setInterval(function () {
                createAutoBackup();
                showBackupNotification('Respaldo automático realizado cada 15 minutos');
            }, 15 * 60 * 1000); // 15 minutos
        }

        // Detener respaldo automático
        function stopAutoBackup() {
            if (autoBackupInterval) {
                clearInterval(autoBackupInterval);
                autoBackupInterval = null;
            }
        }

        // Mostrar notificación de respaldo
        function showBackupNotification(message) {
            document.getElementById('backupNotificationText').textContent = message;
            document.getElementById('backupNotification').style.display = 'block';

            setTimeout(function () {
                document.getElementById('backupNotification').style.display = 'none';
            }, 5000);
        }

        // Crear respaldo automático periódico (ACTUALIZADA)
        function createAutoBackup() {
            try {
                const backupKey = 'gymSystemBackup';
                const backupData = {
                    users: users,
                    attendance: attendance,
                    income: income,
                    expenses: expenses,
                    staffClasses: staffClasses,
                    timestamp: new Date().toISOString(),
                    totalRecords: {
                        users: users.length,
                        attendance: attendance.length,
                        income: income.length,
                        expenses: expenses.length,
                        staffClasses: staffClasses.length
                    }
                };

                // Guardar en localStorage
                localStorage.setItem(backupKey, JSON.stringify(backupData));
                lastBackup = new Date().toLocaleString();
                localStorage.setItem('lastBackup', lastBackup);
                updateSystemInfo();
            } catch (error) {
                console.error("Error al crear respaldo automático:", error);
            }
        }
        
        // Actualizar vista previa del formulario de WhatsApp
        function updateWhatsAppFormPreview() {
            const name = document.getElementById('clientName').value || '[Nombre del cliente]';
            const phone = document.getElementById('clientPhone').value || '[Teléfono]';
            const groupLink = document.getElementById('whatsappGroupLink').value;
            const includeGroupLink = document.getElementById('includeGroupLink').checked;
            const includeGoogleForm = document.getElementById('includeGoogleForm').checked;

            let message = `Hola ${name}, bienvenido/a a Antología Box23. Para completar tu registro, necesitamos los siguientes datos:
            
1. Nombre completo:
2. Número de documento:
3. Fecha de nacimiento:
4. Tipo de sangre (RH):
5. EPS:
6. Alguna patología o condición médica que debamos conocer:
7. Teléfono de contacto de emergencia:
8. Nombre del contacto de emergencia:

¡Gracias por colaborar!`;

            if (includeGroupLink && groupLink) {
                message += `\n\nÚnete a nuestro grupo de WhatsApp: ${groupLink}`;
            }

            if (includeGoogleForm) {
                message += `\n\nO completa nuestro formulario en línea: https://forms.gle/ZHUj1Q7YiDhE5P498`;
            }

            document.getElementById('whatsappFormPreview').textContent = message;

            // Actualizar enlace de WhatsApp
            const encodedMessage = encodeURIComponent(message);
            const cleanedPhone = cleanPhone(phone);
            document.getElementById('whatsappFormLink').href = `https://wa.me/57${cleanedPhone}?text=${encodedMessage}`;
        }

        // MEJORADA: Cargar usuarios en las listas desplegables con búsqueda
        function loadUserSelects() {
            const userSelect = document.getElementById('incomeUserSelect');
            const incomeFilterUser = document.getElementById('incomeFilterUser');
            const attendanceUserFilter = document.getElementById('attendanceUserFilter');
            const combinedReportUser = document.getElementById('combinedReportUser');
            const classRecordTrainer = document.getElementById('classRecordTrainer');
            const paymentTrainerFilter = document.getElementById('paymentTrainerFilter');
            const historyTrainerFilter = document.getElementById('historyTrainerFilter');

            // Limpiar selects
            if (userSelect) userSelect.innerHTML = '<option value="">Seleccionar usuario</option>';
            if (incomeFilterUser) incomeFilterUser.innerHTML = '<option value="">Todos los usuarios</option>';
            if (attendanceUserFilter) attendanceUserFilter.innerHTML = '<option value="">Todos los usuarios</option>';
            if (combinedReportUser) combinedReportUser.innerHTML = '<option value="">Todos los usuarios</option>';
            if (classRecordTrainer) classRecordTrainer.innerHTML = '<option value="">Seleccionar entrenador</option>';
            if (paymentTrainerFilter) paymentTrainerFilter.innerHTML = '<option value="">Todos los entrenadores</option>';
            if (historyTrainerFilter) historyTrainerFilter.innerHTML = '<option value="">Todos los entrenadores</option>';

            // Llenar con usuarios activos
            users.forEach(user => {
                if (user.status !== 'inactive') {
                    // Para el select de pagos (con información completa)
                    if (userSelect) {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = `${user.name} - ${user.classTime} - ${user.document || 'Sin documento'}`;
                        userSelect.appendChild(option);
                    }

                    // Para filtros (solo nombre)
                    if (incomeFilterUser) {
                        const filterOption = document.createElement('option');
                        filterOption.value = user.id;
                        filterOption.textContent = user.name;
                        incomeFilterUser.appendChild(filterOption);
                    }

                    if (attendanceUserFilter) {
                        const attendanceFilterOption = document.createElement('option');
                        attendanceFilterOption.value = user.id;
                        attendanceFilterOption.textContent = user.name;
                        attendanceUserFilter.appendChild(attendanceFilterOption);
                    }

                    if (combinedReportUser) {
                        const combinedReportOption = document.createElement('option');
                        combinedReportOption.value = user.id;
                        combinedReportOption.textContent = user.name;
                        combinedReportUser.appendChild(combinedReportOption);
                    }
                }

                // NUEVO: Solo entrenadores para los selects de personal
                if (user.affiliationType === 'Entrenador(a)' && user.status !== 'inactive') {
                    if (classRecordTrainer) {
                        const trainerOption = document.createElement('option');
                        trainerOption.value = user.id;
                        trainerOption.textContent = user.name;
                        classRecordTrainer.appendChild(trainerOption);
                    }

                    if (paymentTrainerFilter) {
                        const trainerFilterOption = document.createElement('option');
                        trainerFilterOption.value = user.id;
                        trainerFilterOption.textContent = user.name;
                        paymentTrainerFilter.appendChild(trainerFilterOption);
                    }

                    if (historyTrainerFilter) {
                        const historyFilterOption = document.createElement('option');
                        historyFilterOption.value = user.id;
                        historyFilterOption.textContent = user.name;
                        historyTrainerFilter.appendChild(historyFilterOption);
                    }
                }
            });

            // Configurar búsqueda en tiempo real para el select de pagos
            setupUserSearch();
        }

        // NUEVA: Función para cargar entrenadores en los selects
        function loadTrainers() {
            const classRecordTrainer = document.getElementById('classRecordTrainer');
            const paymentTrainerFilter = document.getElementById('paymentTrainerFilter');
            const historyTrainerFilter = document.getElementById('historyTrainerFilter');

            // Limpiar selects
            if (classRecordTrainer) classRecordTrainer.innerHTML = '<option value="">Seleccionar entrenador</option>';
            if (paymentTrainerFilter) paymentTrainerFilter.innerHTML = '<option value="">Todos los entrenadores</option>';
            if (historyTrainerFilter) historyTrainerFilter.innerHTML = '<option value="">Todos los entrenadores</option>';

            // Llenar con entrenadores activos
            users.forEach(user => {
                if (user.affiliationType === 'Entrenador(a)' && user.status !== 'inactive') {
                    if (classRecordTrainer) {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.name;
                        classRecordTrainer.appendChild(option);
                    }

                    if (paymentTrainerFilter) {
                        const filterOption = document.createElement('option');
                        filterOption.value = user.id;
                        filterOption.textContent = user.name;
                        paymentTrainerFilter.appendChild(filterOption);
                    }

                    if (historyTrainerFilter) {
                        const historyOption = document.createElement('option');
                        historyOption.value = user.id;
                        historyOption.textContent = user.name;
                        historyTrainerFilter.appendChild(historyOption);
                    }
                }
            });
        }

        // NUEVA: Función para configurar búsqueda en tiempo real en pagos
        function setupUserSearch() {
            // Verificar si ya existe el campo de búsqueda
            let searchInput = document.getElementById('incomeUserSearch');

            if (!searchInput) {
                // Crear el campo de búsqueda si no existe
                const incomeForm = document.getElementById('incomeForm');
                const userSelectContainer = incomeForm.querySelector('#incomeUserSelect')?.parentNode;

                if (!userSelectContainer) return;

                const searchContainer = document.createElement('div');
                searchContainer.className = 'mb-3';
                searchContainer.innerHTML = `
                    <label for="incomeUserSearch" class="form-label">Buscar usuario</label>
                    <input type="text" class="form-control" id="incomeUserSearch" placeholder="Escriba nombre, documento o clase...">
                `;

                incomeForm.insertBefore(searchContainer, userSelectContainer);

                // Actualizar referencia
                searchInput = document.getElementById('incomeUserSearch');
            }

            // Agregar evento de búsqueda
            if (searchInput) {
                searchInput.addEventListener('input', function () {
                    const searchText = this.value.toLowerCase();
                    const userSelect = document.getElementById('incomeUserSelect');
                    if (!userSelect) return;
                    
                    const options = userSelect.options;

                    // Mostrar/ocultar opciones según la búsqueda
                    for (let i = 0; i < options.length; i++) {
                        const option = options[i];
                        if (option.textContent.toLowerCase().includes(searchText)) {
                            option.style.display = '';
                        } else {
                            option.style.display = 'none';
                        }
                    }

                    // Si solo hay una opción visible, seleccionarla automáticamente
                    const visibleOptions = Array.from(options).filter(opt => opt.style.display !== 'none');
                    if (visibleOptions.length === 1 && visibleOptions[0].value) {
                        userSelect.value = visibleOptions[0].value;
                    }
                });
            }
        }

        // Cargar lista de usuarios
        function loadUsers() {
            const usersList = document.getElementById('usersList');
            if (!usersList) return;
            
            usersList.innerHTML = '';
            
            users.forEach(user => {
                const statusBadge = user.status === 'active'
                    ? '<span class="badge bg-success user-status-badge">Activo</span>'
                    : '<span class="badge bg-danger user-status-badge">Inactivo</span>';

                // Verificar si el usuario tiene cumpleaños próximos (3 días)
                const birthdayInfo = getUpcomingBirthdayInfo(user.birthdate);
                const birthdayBadge = birthdayInfo ? `<span class="birthday-badge">🎂 ${birthdayInfo.daysUntil} días</span>` : '';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.name} ${birthdayBadge}</td>
                    <td>${user.document || '-'}</td>
                    <td>${user.phone || '-'}</td>
                    <td>${user.classTime || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-info me-1" onclick="editUser('${user.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-warning me-1" onclick="showEmergencyInfo('${user.id}')">
                            <i class="fas fa-first-aid"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                usersList.appendChild(row);
            });

            loadUserSelects();
            loadTrainers();
            updateSystemInfo();

            // Crear respaldo automático después de cargar usuarios
            createAutoBackup();

            // Verificar cumpleaños próximos al cargar usuarios
            checkUpcomingBirthdays();
        }

        // Mostrar información de emergencia
        function showEmergencyInfo(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            const emergencyInfoContent = document.getElementById('emergencyInfoContent');
            if (!emergencyInfoContent) return;
            
            emergencyInfoContent.innerHTML = `
                <h6>Información de ${user.name}</h6>
                <div class="emergency-info">
                    <p><strong>EPS:</strong> ${user.eps || 'No registrada'}</p>
                    <p><strong>Tipo de sangre (RH):</strong> ${user.rh || 'No registrado'}</p>
                    <p><strong>Patologías:</strong> ${user.pathology || 'Ninguna registrada'}</p>
                    <p><strong>Contacto de emergencia:</strong> ${user.emergencyContact || 'No registrado'}</p>
                    <p><strong>Teléfono de emergencia:</strong> ${user.emergencyPhone || 'No registrado'}</p>
                </div>
            `;

            const emergencyModal = new bootstrap.Modal(document.getElementById('emergencyInfoModal'));
            emergencyModal.show();
        }

        // Editar usuario
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            // Llenar el formulario de edición
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editName').value = user.name;
            document.getElementById('editDocument').value = user.document || '';

            // Manejar fecha de nacimiento
            document.getElementById('editBirthdate').value = user.birthdate || '';

            // Manejar teléfono
            document.getElementById('editPhone').value = user.phone || '';

            document.getElementById('editEps').value = user.eps || '';
            document.getElementById('editRh').value = user.rh || '';
            document.getElementById('editPathology').value = user.pathology || '';
            document.getElementById('editEmergencyContact').value = user.emergencyContact || '';

            // Manejar teléfono de emergencia
            document.getElementById('editEmergencyPhone').value = user.emergencyPhone || '';

            document.getElementById('editClassTime').value = user.classTime || '';
            document.getElementById('editAffiliationType').value = user.affiliationType || '';
            document.getElementById('editStatus').value = user.status || 'active';

            // Mostrar el modal
            const editUserModal = new bootstrap.Modal(document.getElementById('editUserModal'));
            editUserModal.show();
        }

        // Guardar usuario editado
        const saveEditUserBtn = document.getElementById('saveEditUser');
        if (saveEditUserBtn) {
            saveEditUserBtn.addEventListener('click', function () {
                const userId = document.getElementById('editUserId').value;
                const userIndex = users.findIndex(u => u.id === userId);

                if (userIndex === -1) return;

                // Validar teléfonos
                const phone = document.getElementById('editPhone').value;
                const emergencyPhone = document.getElementById('editEmergencyPhone').value;

                if (phone && !isValidPhone(phone)) {
                    alert('El formato del teléfono principal es inválido. Debe tener 10 dígitos y comenzar con 3.');
                    return;
                }

                if (emergencyPhone && !isValidPhone(emergencyPhone)) {
                    alert('El formato del teléfono de emergencia es inválido. Debe tener 10 dígitos y comenzar con 3.');
                    return;
                }

                // Actualizar datos del usuario
                users[userIndex] = {
                    ...users[userIndex],
                    name: document.getElementById('editName').value,
                    document: document.getElementById('editDocument').value,
                    birthdate: document.getElementById('editBirthdate').value,
                    phone: document.getElementById('editPhone').value,
                    eps: document.getElementById('editEps').value,
                    rh: document.getElementById('editRh').value,
                    pathology: document.getElementById('editPathology').value,
                    emergencyContact: document.getElementById('editEmergencyContact').value,
                    emergencyPhone: document.getElementById('editEmergencyPhone').value,
                    classTime: document.getElementById('editClassTime').value,
                    affiliationType: document.getElementById('editAffiliationType').value,
                    status: document.getElementById('editStatus').value
                };

                // Guardar en localStorage
                saveToLocalStorage();

                // Recargar la lista
                loadUsers();

                // Cerrar el modal
                const editUserModal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
                if (editUserModal) editUserModal.hide();

                alert('Usuario actualizado correctamente!');
            });
        }

        // Función para obtener el último pago de un usuario
        function getLastPayment(userId) {
            const userPayments = income.filter(payment => payment.userId == userId);
            if (userPayments.length === 0) return null;

            userPayments.sort((a, b) => {
                // Convertir a fechas para comparación
                const dateA = new Date(a.endDate);
                const dateB = new Date(b.endDate);
                return dateB - dateA; // Orden descendente
            });
            return userPayments[0];
        }

        // MEJORA 2: Función para verificar estado de membresía con información de clases asistidas para TODOS los tipos de pago
        function checkMembershipStatus(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return { 
                expired: false, 
                daysExpired: 0, 
                classesAttended: 0, 
                totalClasses: null, 
                paymentType: null, 
                endDate: null, 
                startDate: null,
                classesAfterExpiration: 0,
                lastPayment: null
            };
            
            // Obtener el último pago (ordenado por fecha de vencimiento)
            const lastPayment = getLastPayment(userId);
            if (!lastPayment) {
                return { 
                    expired: true, 
                    daysExpired: 'N/A', 
                    classesAttended: 0, 
                    totalClasses: null, 
                    paymentType: null, 
                    endDate: null, 
                    startDate: null,
                    classesAfterExpiration: 0,
                    lastPayment: null
                };
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Asegurarnos de que las fechas estén correctamente parseadas
            const endDate = new Date(lastPayment.endDate);
            endDate.setHours(0, 0, 0, 0);
            
            const startDate = new Date(lastPayment.startDate);
            startDate.setHours(0, 0, 0, 0);
            
            // Contar TODAS las clases asistidas desde la fecha de inicio del último pago
            let classesAttended = 0;
            let classesAfterExpiration = 0;
            
            const userAttendance = attendance.filter(a => 
                a.userId === userId && 
                a.status === 'presente'
            );
            
            userAttendance.forEach(att => {
                const attDate = new Date(att.date);
                attDate.setHours(0, 0, 0, 0);
                
                // Si la asistencia es después de la fecha de inicio del período
                if (attDate >= startDate) {
                    classesAttended++;
                    
                    // Si la asistencia es después de la fecha de vencimiento
                    if (attDate > endDate) {
                        classesAfterExpiration++;
                    }
                }
            });
                   
            // Determinar total de clases según el tipo de pago
            let totalClasses = null;
            const paymentType = lastPayment.paymentType || user.affiliationType;
            
            switch(paymentType) {
                case 'paquete 10 clases':
                    totalClasses = 10;
                    break;
                case 'clase suelta':
                    totalClasses = 1;
                    break;
                case 'mensualidad':
                    // Estimación: 4 semanas x 6 clases/semana = 24 clases
                    totalClasses = 24;
                    break;
                case 'personalizado Diana':
                    totalClasses = 12;
                    break;
                default:
                    totalClasses = null;
            }

            if (today > endDate) {
                // Calcular días de vencimiento
                const diffTime = Math.abs(today - endDate);
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                return { 
                    expired: true, 
                    daysExpired: diffDays, 
                    classesAttended: classesAttended,
                    totalClasses: totalClasses,
                    paymentType: paymentType,
                    endDate: lastPayment.endDate,
                    startDate: lastPayment.startDate,
                    classesAfterExpiration: classesAfterExpiration,
                    lastPayment: lastPayment
                };
            }

            return { 
                expired: false, 
                daysExpired: 0, 
                classesAttended: classesAttended,
                totalClasses: totalClasses,
                paymentType: paymentType,
                endDate: lastPayment.endDate,
                startDate: lastPayment.startDate,
                classesAfterExpiration: classesAfterExpiration,
                lastPayment: lastPayment
            };
        }

        // Cargar asistencias - NUEVA VERSIÓN MEJORADA (lista única ordenada alfabéticamente)
        function loadAttendanceByClass() {
            const attendanceDate = document.getElementById('attendanceDate').value;
            const attendanceUsersList = document.getElementById('attendanceUsersList');
            if (!attendanceUsersList) return;
            
            attendanceUsersList.innerHTML = '';

            let totalUsers = 0;
            let presentUsers = 0;
            
            // Obtener usuarios activos (excepto entrenadores) y ordenarlos alfabéticamente
            const activeUsers = users
                .filter(user => user.status === 'active' && user.affiliationType !== 'Entrenador(a)')
                .sort((a, b) => a.name.localeCompare(b.name));

            totalUsers = activeUsers.length;

            activeUsers.forEach(user => {
                const isPresent = attendance.some(a =>
                    a.userId === user.id &&
                    a.date === attendanceDate &&
                    a.status === 'presente'
                );

                if (isPresent) presentUsers++;

                // MEJORA 2: Verificar estado de membresía para cualquier tipo de pago
                const membershipStatus = checkMembershipStatus(user.id);
                
                // Obtener el último pago del usuario
                const lastPayment = getLastPayment(user.id);
                if (!lastPayment) {
                    return { 
                        expired: true, 
                        daysExpired: 'N/A', 
                        classesAttended: 0, 
                        totalClasses: null, 
                        paymentType: null, 
                        endDate: null, 
                        startDate: null,
                        classesAfterExpiration: 0,
                        lastPayment: null
                    };
                }
                
                const today = new Date();
                const endDate = new Date(lastPayment.endDate);
                const startDate = new Date(lastPayment.startDate);
                
                
                // MEJORA 2: Crear texto de información de membresía mejorado
                let membershipInfo = '';
                if (lastPayment) {
                    const addOneDay = (date) => {
                        const d = new Date(date);       // Crear objeto Date
                        d.setDate(d.getDate() + 1);     // Sumar un día
                        return d;
                    };
                    membershipInfo = `Vigencia: ${formatDate(addOneDay(lastPayment.startDate))} - ${formatDate(addOneDay(lastPayment.endDate))}`;
                    
                    // Mostrar información de clases asistidas independientemente del estado
                    if (membershipStatus.expired) {
                        if (membershipStatus.totalClasses !== null) {
                            membershipInfo += ` | <span class="text-warning"><i class="fas fa-exclamation-triangle"></i> Vencida hace ${membershipStatus.daysExpired} días, asistió a ${membershipStatus.classesAttended} de ${membershipStatus.totalClasses} clases (${membershipStatus.paymentType})`;
                            
                            // NUEVO: Mostrar clases después del vencimiento si hay
                            if (membershipStatus.classesAfterExpiration > 0) {
                                membershipInfo += `, lleva ${membershipStatus.classesAfterExpiration} clases después del vencimiento`;
                            }
                            
                            membershipInfo += `</span>`;
                        } else {
                            membershipInfo += ` | <span class="text-warning"><i class="fas fa-exclamation-triangle"></i> Vencida hace ${membershipStatus.daysExpired} días, asistió a ${membershipStatus.classesAttended} clases (${membershipStatus.paymentType})`;
                            
                            // NUEVO: Mostrar clases después del vencimiento si hay
                            if (membershipStatus.classesAfterExpiration > 0) {
                                membershipInfo += `, lleva ${membershipStatus.classesAfterExpiration} clases después del vencimiento`;
                            }
                            
                            membershipInfo += `</span>`;
                        }
                    } else {
                        // Mostrar progreso incluso si no está vencida
                        if (membershipStatus.totalClasses !== null) {
                            membershipInfo += ` | Progreso: ${membershipStatus.classesAttended} de ${membershipStatus.totalClasses} clases (${membershipStatus.paymentType})`;
                        } else {
                            membershipInfo += ` | Asistencias en período: ${membershipStatus.classesAttended} clases (${membershipStatus.paymentType})`;
                        }
                    }
                } else {
                    membershipInfo = 'Sin pago registrado';
                }

                const userItem = document.createElement('div');
                userItem.className = 'attendance-user-item';
                userItem.innerHTML = `
                    <div class="attendance-check-container">
                        <input class="form-check-input attendance-checkbox" type="checkbox" 
                            id="attendance-${user.id}" 
                            data-user-id="${user.id}"
                            ${isPresent ? 'checked' : ''}>
                    </div>
                    <div class="attendance-user-info">
                        <div class="attendance-user-name">${user.name}</div>
                        <div class="attendance-user-details">
                            ${membershipInfo}
                        </div>
                    </div>
                    <div class="attendance-actions">
                        <button class="btn btn-sm btn-outline-info" onclick="showEmergencyInfo('${user.id}')">
                            <i class="fas fa-first-aid"></i>
                        </button>
                    </div>
                `;

                attendanceUsersList.appendChild(userItem);
            });

            // Actualizar estadísticas
            const totalUsersCount = document.getElementById('totalUsersCount');
            const presentUsersCount = document.getElementById('presentUsersCount');
            const pendingUsersCount = document.getElementById('pendingUsersCount');
            
            if (totalUsersCount) totalUsersCount.textContent = totalUsers;
            if (presentUsersCount) presentUsersCount.textContent = presentUsers;
            if (pendingUsersCount) pendingUsersCount.textContent = totalUsers - presentUsers;

            // Agregar event listeners a los checkboxes
            document.querySelectorAll('.attendance-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateAttendanceStats);
            });

            // Verificar inasistencias consecutivas
            checkConsecutiveAbsences();

            // Crear respaldo automático después de cargar asistencias
            createAutoBackup();
        }

        // Actualizar estadísticas de asistencia
        function updateAttendanceStats() {
            const totalCheckboxes = document.querySelectorAll('.attendance-checkbox').length;
            const presentCheckboxes = document.querySelectorAll('.attendance-checkbox:checked').length;

            const presentUsersCount = document.getElementById('presentUsersCount');
            const pendingUsersCount = document.getElementById('pendingUsersCount');
            
            if (presentUsersCount) presentUsersCount.textContent = presentCheckboxes;
            if (pendingUsersCount) pendingUsersCount.textContent = totalCheckboxes - presentCheckboxes;
        }

        // Función para verificar inasistencias consecutivas
        function checkConsecutiveAbsences() {
            const absenceAlertsList = document.getElementById('absenceAlertsList');
            if (!absenceAlertsList) return;
            
            absenceAlertsList.innerHTML = '';

            const activeUsers = users.filter(user =>
                user.status === 'active' && user.affiliationType !== 'Entrenador(a)'
            );

            let hasAlerts = false;

            activeUsers.forEach(user => {
                const userAttendance = attendance
                    .filter(a => a.userId === user.id && a.status === 'presente')
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Obtener las últimas 5 fechas de asistencia registradas (no necesariamente consecutivas)
                const lastAttendanceDates = userAttendance.slice(0, 5).map(a => a.date);

                // Encontrar la última fecha de asistencia
                const lastAttendanceDate = lastAttendanceDates.length > 0 ?
                    new Date(lastAttendanceDates[0]) : null;

                if (lastAttendanceDate) {
                    // Calcular días desde la última asistencia
                    const today = new Date();
                    const diffTime = Math.abs(today - lastAttendanceDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    // Si han pasado más de 7 días desde la última asistencia, mostrar alerta
                    if (diffDays > 7) {
                        hasAlerts = true;

                        const alertItem = document.createElement('div');
                        alertItem.className = 'absence-alert-item';
                        alertItem.innerHTML = `
                            <div class="absence-alert-header">
                                <div>
                                    <strong>${user.name}</strong> - No asiste desde hace ${diffDays} días
                                    <br>
                                    <small>Última asistencia: ${formatDate(lastAttendanceDate.toISOString().split('T')[0])}</small>
                                </div>
                                <div class="absence-alert-actions">
                                    <button class="btn btn-sm btn-success me-1" onclick="sendReminderWhatsApp('${user.id}')">
                                        <i class="fab fa-whatsapp"></i> Recordatorio
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="inactivateUser('${user.id}')">
                                        <i class="fas fa-user-slash"></i> Inactivar
                                    </button>
                                </div>
                            </div>
                        `;
                        absenceAlertsList.appendChild(alertItem);
                    }
                }
            });

            if (!hasAlerts) {
                absenceAlertsList.innerHTML = '<p class="text-muted">No hay alertas de inasistencias en este momento.</p>';
            }
        }

        // Función para enviar recordatorio por WhatsApp
        function sendReminderWhatsApp(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            // Validar teléfono
            if (!isValidPhone(user.phone)) {
                alert('El usuario no tiene un número de teléfono válido. Por favor, edite el usuario y agregue un número válido.');
                return;
            }

            // Rellenar el formulario de WhatsApp
            document.getElementById('whatsappNumber').value = cleanPhone(user.phone);

            // Crear mensaje de recordatorio personalizado
            const lastAttendance = attendance
                .filter(a => a.userId === userId && a.status === 'presente')
                .sort((a, b) => new Date(b.date) - new Date(a.date))[0];

            const lastAttendanceDate = lastAttendance ? formatDate(lastAttendance.date) : 'No registrada';

            const message = `Hola ${user.name}, ¡te extrañamos en Antología Box23! 👋

Hemos notado que no hemos tenido el gusto de verte desde el ${lastAttendanceDate}. 

¿Todo bien? Esperamos que puedas regresar pronto a tus entrenamientos. Si hay algún inconveniente o necesitas ayuda, no dudes en contarnos.

¡Quedamos atentos a cualquier inquietud!

💪 El equipo de Antología Box23`;

            document.getElementById('whatsappMessage').value = message;
            document.getElementById('messagePreview').textContent = message;

            // Actualizar enlace de WhatsApp
            updateWhatsAppLink();

            // Mostrar modal
            const whatsappModal = new bootstrap.Modal(document.getElementById('whatsappModal'));
            whatsappModal.show();
        }

        // Función para inactivar usuario
        function inactivateUser(userId) {
            if (confirm('¿Está seguro de que desea inactivar este usuario? Esto cambiará su estado a inactivo.')) {
                const userIndex = users.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    users[userIndex].status = 'inactive';
                    saveToLocalStorage();
                    loadUsers();
                    checkConsecutiveAbsences(); // Recargar alertas
                    alert('Usuario inactivado correctamente.');
                }
            }
        }

        // Cargar lista de asistencias
        function loadAttendance() {
            const attendanceList = document.getElementById('attendanceList');
            if (!attendanceList) return;
            
            attendanceList.innerHTML = '';
            
            const startDate = document.getElementById('attendanceStartDateFilter').value;
            const endDate = document.getElementById('attendanceEndDateFilter').value;
            const userId = document.getElementById('attendanceUserFilter').value;

            let filteredAttendance = attendance;

            // Filtrar por fecha
            if (startDate && endDate) {
                filteredAttendance = filteredAttendance.filter(a => a.date >= startDate && a.date <= endDate);
            }

            // Filtrar por usuario
            if (userId) {
                filteredAttendance = filteredAttendance.filter(a => a.userId == userId);
            }

            filteredAttendance.forEach(record => {
                const user = users.find(u => u.id == record.userId) || { name: 'Usuario eliminado', classTime: 'N/A' };
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td>${user.name}</td>
                    <td>${user.classTime}</td>
                    <td>
                        <span class="badge ${getStatusBadgeClass(record.status)}">${record.status}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteAttendance(${record.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                attendanceList.appendChild(row);
            });

            updateSystemInfo();
        }

        // Obtener clase CSS para el badge de estado
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'presente': return 'bg-success';
                case 'ausente': return 'bg-danger';
                case 'tarde': return 'bg-warning';
                case 'permiso': return 'bg-info';
                default: return 'bg-secondary';
            }
        }

        // Eliminar registro de pago
        function deleteIncome(incomeId) {
            if (confirm('¿Está seguro de que desea eliminar este registro de pago?')) {
                income = income.filter(i => i.id !== incomeId);
                saveToLocalStorage();
                loadIncome();
                alert('Registro de pago eliminado correctamente.');
            }
        }

        // Eliminar registro de asistencia
        function deleteAttendance(attendanceId) {
            if (confirm('¿Está seguro de que desea eliminar este registro de asistencia?')) {
                attendance = attendance.filter(a => a.id !== attendanceId);
                saveToLocalStorage();
                loadAttendance();
                alert('Registro de asistencia eliminado correctamente.');
            }
        }

        // NUEVO: Eliminar gasto
        function deleteExpense(expenseId) {
            if (confirm('¿Está seguro de que desea eliminar este registro de gasto?')) {
                expenses = expenses.filter(e => e.id !== expenseId);
                saveToLocalStorage();
                loadExpenses();
                loadAccountBalances();
                alert('Registro de gasto eliminado correctamente.');
            }
        }

        // NUEVO: Eliminar clase de personal
        function deleteStaffClass(classId) {
            if (confirm('¿Está seguro de que desea eliminar este registro de clase?')) {
                staffClasses = staffClasses.filter(c => c.id !== classId);
                saveToLocalStorage();
                loadStaffClasses();
                loadClassHistory();
                alert('Registro de clase eliminado correctamente.');
            }
        }

        // Eliminar usuario
        function deleteUser(userId) {
            if (confirm('¿Está seguro de que desea eliminar este usuario?')) {
                users = users.filter(user => user.id !== userId);
                saveToLocalStorage();
                loadUsers();
            }
        }

        // MEJORA 2: Verificar estado de membresía y mostrar información de clases asistidas
        function checkMembershipAndClasses() {
            const filterUser = document.getElementById('incomeFilterUser').value;

            if (!filterUser) {
                const packageWarning = document.getElementById('packageWarning');
                if (packageWarning) packageWarning.classList.add('d-none');
                return;
            }

            const user = users.find(u => u.id == filterUser);
            if (!user) {
                const packageWarning = document.getElementById('packageWarning');
                if (packageWarning) packageWarning.classList.add('d-none');
                return;
            }

            // Verificar estado de membresía con la nueva función
            const membershipStatus = checkMembershipStatus(filterUser);
            
            let warningMessage = '';
            
            if (membershipStatus.expired) {
                if (membershipStatus.totalClasses !== null) {
                    warningMessage = `¡Atención! La membresía de ${user.name} está vencida hace ${membershipStatus.daysExpired} días. Asistió a ${membershipStatus.classesAttended} de ${membershipStatus.totalClasses} clases (${membershipStatus.paymentType}).`;
                    
                    // NUEVO: Agregar información de clases después del vencimiento
                    if (membershipStatus.classesAfterExpiration > 0) {
                        warningMessage += ` Lleva ${membershipStatus.classesAfterExpiration} clases después del vencimiento.`;
                    }
                } else {
                    warningMessage = `¡Atención! La membresía de ${user.name} está vencida hace ${membershipStatus.daysExpired} días. Asistió a ${membershipStatus.classesAttended} clases en este período (${membershipStatus.paymentType}).`;
                    
                    // NUEVO: Agregar información de clases después del vencimiento
                    if (membershipStatus.classesAfterExpiration > 0) {
                        warningMessage += ` Lleva ${membershipStatus.classesAfterExpiration} clases después del vencimiento.`;
                    }
                }
                document.getElementById('warningText').textContent = warningMessage;
                document.getElementById('packageWarning').classList.remove('d-none');
            } else {
                // Mostrar progreso incluso si no está vencida
                if (membershipStatus.totalClasses !== null) {
                    warningMessage = `${user.name} - Progreso: ${membershipStatus.classesAttended} de ${membershipStatus.totalClasses} clases (${membershipStatus.paymentType})`;
                } else {
                    warningMessage = `${user.name} - Asistencias en período: ${membershipStatus.classesAttended} clases (${membershipStatus.paymentType})`;
                }
                document.getElementById('warningText').textContent = warningMessage;
                document.getElementById('packageWarning').classList.remove('d-none');
            }
        }

        // Cargar lista de pagos (ACTUALIZADA para mostrar cuenta)
        function loadIncome() {
            const incomeList = document.getElementById('incomeList');
            if (!incomeList) return;
            
            incomeList.innerHTML = '';
            
            const startDate = document.getElementById('incomeStartDateFilter').value;
            const endDate = document.getElementById('incomeEndDateFilter').value;
            const userId = document.getElementById('incomeFilterUser').value;

            let filteredIncome = income;
            let total = 0;

            // Filtrar por fecha
            if (startDate && endDate) {
                filteredIncome = filteredIncome.filter(i => i.paymentDate >= startDate && i.paymentDate <= endDate);
            }

            // Filtrar por usuario
            if (userId) {
                filteredIncome = filteredIncome.filter(i => i.userId == userId);
            }

            filteredIncome.forEach(record => {
                const user = users.find(u => u.id == record.userId) || { name: 'Usuario eliminado' };
                const amount = parseFloat(record.amount);
                total += amount;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.paymentDate}</td>
                    <td>${user.name}</td>
                    <td>$${amount.toFixed(2)}</td>
                    <td>${record.paymentType || '-'}</td>
                    <td>${record.account || '-'}</td>
                    <td>${record.endDate}</td>
                    <td>${record.description || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteIncome(${record.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                incomeList.appendChild(row);
            });

            // Actualizar total
            const incomeTotal = document.getElementById('incomeTotal');
            if (incomeTotal) incomeTotal.textContent = `$${total.toFixed(2)}`;

            updateSystemInfo();
            // MEJORA 2: Cambiar a nueva función
            checkMembershipAndClasses();

            // Crear respaldo automático después de cargar pagos
            createAutoBackup();
        }

        // =============================================
        // FUNCIONES NUEVAS COMPLETAS
        // =============================================

        // NUEVO: Función para cargar saldos por cuenta
        function loadAccountBalances() {
            const accountBalancesList = document.getElementById('accountBalancesList');
            if (!accountBalancesList) return;
            
            accountBalancesList.innerHTML = '';

            // Definir las cuentas disponibles
            const accounts = ['efectivo', 'bancolombia', 'daviplata', 'nequi'];
            let totalBalance = 0;

            accounts.forEach(account => {
                // Calcular ingresos por cuenta
                const accountIncome = income
                    .filter(payment => payment.account === account)
                    .reduce((sum, payment) => sum + parseFloat(payment.amount), 0);

                // Calcular gastos por cuenta
                const accountExpenses = expenses
                    .filter(expense => expense.account === account)
                    .reduce((sum, expense) => sum + parseFloat(expense.amount), 0);

                // Calcular saldo (ingresos - gastos)
                const accountBalance = accountIncome - accountExpenses;
                totalBalance += accountBalance;

                // Formatear nombres de cuentas
                let accountName = '';
                switch(account) {
                    case 'efectivo':
                        accountName = '💵 Efectivo';
                        break;
                    case 'bancolombia':
                        accountName = '🏦 Bancolombia';
                        break;
                    case 'daviplata':
                        accountName = '📱 Daviplata';
                        break;
                    case 'nequi':
                        accountName = '📲 Nequi';
                        break;
                    default:
                        accountName = account;
                }

                const accountItem = document.createElement('div');
                accountItem.className = 'account-item';
                accountItem.innerHTML = `
                    <div class="account-name">
                        ${accountName}
                        <br>
                        <small class="text-muted">
                            Ingresos: $${accountIncome.toLocaleString('es-ES', {minimumFractionDigits: 2})} | 
                            Gastos: $${accountExpenses.toLocaleString('es-ES', {minimumFractionDigits: 2})}
                        </small>
                    </div>
                    <div class="account-balance-amount">
                        $${accountBalance.toLocaleString('es-ES', {minimumFractionDigits: 2})}
                    </div>
                `;
                accountBalancesList.appendChild(accountItem);
            });

            // Actualizar saldo total
            const totalBalanceElement = document.getElementById('totalBalance');
            const infoTotalBalance = document.getElementById('infoTotalBalance');
            
            if (totalBalanceElement) totalBalanceElement.textContent = `Total General: $${totalBalance.toLocaleString('es-ES', {minimumFractionDigits: 2})}`;
            if (infoTotalBalance) infoTotalBalance.textContent = `$${totalBalance.toLocaleString('es-ES', {minimumFractionDigits: 0})}`;
        }

        // NUEVO: Función para cargar gastos
        function loadExpenses() {
            const expensesList = document.getElementById('expensesList');
            if (!expensesList) return;
            
            expensesList.innerHTML = '';
            
            const startDate = document.getElementById('expenseStartDateFilter').value;
            const endDate = document.getElementById('expenseEndDateFilter').value;
            const category = document.getElementById('expenseCategoryFilter').value;
            const account = document.getElementById('expenseAccountFilter').value;

            let filteredExpenses = expenses;
            let total = 0;

            // Filtrar por fecha
            if (startDate && endDate) {
                filteredExpenses = filteredExpenses.filter(e => e.date >= startDate && e.date <= endDate);
            }

            // Filtrar por categoría
            if (category) {
                filteredExpenses = filteredExpenses.filter(e => e.category === category);
            }

            // Filtrar por cuenta
            if (account) {
                filteredExpenses = filteredExpenses.filter(e => e.account === account);
            }

            // Ordenar por fecha (más reciente primero)
            filteredExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));

            filteredExpenses.forEach(expense => {
                const amount = parseFloat(expense.amount);
                total += amount;

                // Formatear categoría
                let categoryBadge = '';
                switch(expense.category) {
                    case 'nómina':
                        categoryBadge = '<span class="expense-category-badge">👥 Nómina</span>';
                        break;
                    case 'arriendo':
                        categoryBadge = '<span class="expense-category-badge">🏠 Arriendo</span>';
                        break;
                    case 'servicios':
                        categoryBadge = '<span class="expense-category-badge">⚡ Servicios</span>';
                        break;
                    case 'mantenimiento':
                        categoryBadge = '<span class="expense-category-badge">🔧 Mantenimiento</span>';
                        break;
                    case 'insumos':
                        categoryBadge = '<span class="expense-category-badge">📦 Insumos</span>';
                        break;
                    case 'marketing':
                        categoryBadge = '<span class="expense-category-badge">📢 Marketing</span>';
                        break;
                    case 'impuestos':
                        categoryBadge = '<span class="expense-category-badge">💰 Impuestos</span>';
                        break;
                    default:
                        categoryBadge = `<span class="expense-category-badge">📝 ${expense.category}</span>`;
                }

                // Formatear cuenta
                let accountName = '';
                switch(expense.account) {
                    case 'efectivo':
                        accountName = '💵 Efectivo';
                        break;
                    case 'bancolombia':
                        accountName = '🏦 Bancolombia';
                        break;
                    case 'daviplata':
                        accountName = '📱 Daviplata';
                        break;
                    case 'nequi':
                        accountName = '📲 Nequi';
                        break;
                    default:
                        accountName = expense.account;
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${expense.date}</td>
                    <td>${expense.description}</td>
                    <td>${categoryBadge}</td>
                    <td>${accountName}</td>
                    <td>$${amount.toFixed(2)}</td>
                    <td>${expense.receipt || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteExpense(${expense.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                expensesList.appendChild(row);
            });

            // Actualizar total
            const expensesTotal = document.getElementById('expensesTotal');
            if (expensesTotal) expensesTotal.textContent = `$${total.toFixed(2)}`;

            // Actualizar información del sistema
            updateSystemInfo();
        }

        // NUEVO: Función para generar reporte financiero
        function generateFinancialReport() {
            const monthInput = document.getElementById('financialReportMonth').value;
            if (!monthInput) {
                alert('Por favor, seleccione un mes.');
                return;
            }

            // Obtener el primer y último día del mes
            const [year, month] = monthInput.split('-');
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0);

            const startDateStr = startDate.toISOString().split('T')[0];
            const endDateStr = endDate.toISOString().split('T')[0];

            // Calcular ingresos del mes
            const monthlyIncome = income
                .filter(payment => payment.paymentDate >= startDateStr && payment.paymentDate <= endDateStr)
                .reduce((sum, payment) => sum + parseFloat(payment.amount), 0);

            // Calcular gastos del mes
            const monthlyExpenses = expenses
                .filter(expense => expense.date >= startDateStr && expense.date <= endDateStr)
                .reduce((sum, expense) => sum + parseFloat(expense.amount), 0);

            // Calcular utilidad neta y margen
            const netProfit = monthlyIncome - monthlyExpenses;
            const profitMargin = monthlyIncome > 0 ? (netProfit / monthlyIncome * 100) : 0;

            // Actualizar estadísticas
            const totalIncomeReport = document.getElementById('totalIncomeReport');
            const totalExpensesReport = document.getElementById('totalExpensesReport');
            const netProfitReport = document.getElementById('netProfitReport');
            const profitMarginReport = document.getElementById('profitMarginReport');
            
            if (totalIncomeReport) totalIncomeReport.textContent = `$${monthlyIncome.toLocaleString('es-ES', {minimumFractionDigits: 2})}`;
            if (totalExpensesReport) totalExpensesReport.textContent = `$${monthlyExpenses.toLocaleString('es-ES', {minimumFractionDigits: 2})}`;
            if (netProfitReport) netProfitReport.textContent = `$${netProfit.toLocaleString('es-ES', {minimumFractionDigits: 2})}`;
            if (profitMarginReport) profitMarginReport.textContent = `${profitMargin.toFixed(1)}%`;

            // Agrupar gastos por categoría
            const expensesByCategory = {};
            const filteredExpenses = expenses.filter(expense => 
                expense.date >= startDateStr && expense.date <= endDateStr
            );

            filteredExpenses.forEach(expense => {
                const category = expense.category || 'otros';
                if (!expensesByCategory[category]) {
                    expensesByCategory[category] = 0;
                }
                expensesByCategory[category] += parseFloat(expense.amount);
            });

            // Mostrar gastos por categoría en la tabla
            const financialReportList = document.getElementById('financialReportList');
            if (financialReportList) {
                financialReportList.innerHTML = '';

                Object.keys(expensesByCategory).forEach(category => {
                    const amount = expensesByCategory[category];
                    const percentage = monthlyExpenses > 0 ? (amount / monthlyExpenses * 100) : 0;
                    
                    // Determinar tendencia (simulado)
                    const trend = percentage > 20 ? '🔺 Alta' : percentage > 10 ? '➡️ Media' : '🔻 Baja';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatCategoryName(category)}</td>
                        <td>$${amount.toLocaleString('es-ES', {minimumFractionDigits: 2})}</td>
                        <td>${percentage.toFixed(1)}%</td>
                        <td>${trend}</td>
                    `;
                    financialReportList.appendChild(row);
                });
            }

            // Actualizar gráfico financiero
            updateFinancialChart(monthlyIncome, monthlyExpenses, netProfit);

            // Mostrar mensaje de éxito
            const monthName = startDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            showBackupNotification(`Reporte financiero generado para ${monthName.charAt(0).toUpperCase() + monthName.slice(1)}`);
        }

        // NUEVO: Función para formatear nombres de categorías
        function formatCategoryName(category) {
            switch(category) {
                case 'nómina':
                    return '👥 Nómina';
                case 'arriendo':
                    return '🏠 Arriendo';
                case 'servicios':
                    return '⚡ Servicios públicos';
                case 'mantenimiento':
                    return '🔧 Mantenimiento';
                case 'insumos':
                    return '📦 Insumos';
                case 'marketing':
                    return '📢 Marketing';
                case 'impuestos':
                    return '💰 Impuestos';
                case 'otros':
                    return '📝 Otros';
                default:
                    return category;
            }
        }

        // NUEVO: Función para actualizar gráfico financiero
        function updateFinancialChart(income, expenses, netProfit) {
            // Destruir gráfico existente si lo hay
            if (financialChart) {
                financialChart.destroy();
            }

            const ctx = document.getElementById('financialChart')?.getContext('2d');
            if (!ctx) return;
            
            financialChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Ingresos', 'Gastos', 'Utilidad Neta'],
                    datasets: [{
                        label: 'Valores ($)',
                        data: [income, expenses, netProfit],
                        backgroundColor: [
                            '#27F9D4', // Ingresos - verde
                            '#FF729F', // Gastos - rosa
                            netProfit >= 0 ? '#F0F66E' : '#FF5A8F' // Utilidad - amarillo si positiva, rojo si negativa
                        ],
                        borderColor: 'var(--color-dark)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `$${context.raw.toLocaleString('es-ES', {minimumFractionDigits: 2})}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#f8f9fa',
                                callback: function(value) {
                                    return '$' + value.toLocaleString('es-ES', {minimumFractionDigits: 0});
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#f8f9fa'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // =============================================
        // FUNCIONES PARA CONTROL DE PERSONAL COMPLETAS
        // =============================================

        // NUEVO: Función para cargar clases de personal
        function loadStaffClasses() {
            // Esta función actualiza los datos en memoria, las vistas específicas se cargan por separado
            updateSystemInfo();
        }

        // NUEVO: Función para calcular pagos a entrenadores
        function calculateTrainerPayments() {
            const startDate = document.getElementById('paymentStartDate').value;
            const endDate = document.getElementById('paymentEndDate').value;
            const trainerId = document.getElementById('paymentTrainerFilter').value;

            if (!startDate || !endDate) {
                alert('Por favor, seleccione un rango de fechas.');
                return;
            }

            // Filtrar clases por rango de fechas y entrenador
            let filteredClasses = staffClasses.filter(record => 
                record.date >= startDate && record.date <= endDate
            );

            if (trainerId) {
                filteredClasses = filteredClasses.filter(record => record.trainerId === trainerId);
            }

            // Agrupar por entrenador
            const classesByTrainer = {};
            filteredClasses.forEach(record => {
                if (!classesByTrainer[record.trainerId]) {
                    classesByTrainer[record.trainerId] = [];
                }
                classesByTrainer[record.trainerId].push(record);
            });

            // Mostrar resultados
            const trainerPaymentsList = document.getElementById('trainerPaymentsList');
            if (!trainerPaymentsList) return;
            
            trainerPaymentsList.innerHTML = '';

            let totalPayment = 0;

            Object.keys(classesByTrainer).forEach(trainerId => {
                const trainer = users.find(u => u.id === trainerId);
                if (!trainer) return;

                const classes = classesByTrainer[trainerId];
                const totalHours = classes.reduce((sum, record) => sum + parseFloat(record.duration), 0);
                const total = totalHours * HOURLY_RATE;
                totalPayment += total;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${trainer.name}</td>
                    <td>${classes.length}</td>
                    <td>${totalHours.toFixed(1)}</td>
                    <td>$${HOURLY_RATE.toLocaleString('es-ES')}</td>
                    <td class="payment-amount">$${total.toLocaleString('es-ES')}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewTrainerDetails('${trainerId}', '${startDate}', '${endDate}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                trainerPaymentsList.appendChild(row);
            });

            // Actualizar total
            const totalPaymentsAmount = document.getElementById('totalPaymentsAmount');
            if (totalPaymentsAmount) totalPaymentsAmount.textContent = `$${totalPayment.toLocaleString('es-ES')}`;

            if (Object.keys(classesByTrainer).length === 0) {
                trainerPaymentsList.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            No se encontraron clases en el período seleccionado
                        </td>
                    </tr>
                `;
            }
        }

        // NUEVO: Función para ver detalles de un entrenador
        function viewTrainerDetails(trainerId, startDate, endDate) {
            const trainer = users.find(u => u.id === trainerId);
            if (!trainer) return;

            // Filtrar clases del entrenador en el período
            const trainerClasses = staffClasses.filter(record => 
                record.trainerId === trainerId &&
                record.date >= startDate && record.date <= endDate
            );

            let message = `Detalles de clases para ${trainer.name}\n\n`;
            message += `Período: ${formatDate(startDate)} - ${formatDate(endDate)}\n\n`;
            
            trainerClasses.forEach((record, index) => {
                message += `${index + 1}. ${record.date} - ${record.time} - ${record.classType} (${record.duration} horas)\n`;
            });

            message += `\nTotal clases: ${trainerClasses.length}\n`;
            const totalHours = trainerClasses.reduce((sum, record) => sum + parseFloat(record.duration), 0);
            message += `Total horas: ${totalHours}\n`;
            message += `Total a pagar: $${(totalHours * HOURLY_RATE).toLocaleString('es-ES')}\n`;

            alert(message);
        }

        // NUEVO: Función para cargar historial de clases
        function loadClassHistory() {
            const startDate = document.getElementById('historyStartDate').value;
            const endDate = document.getElementById('historyEndDate').value;
            const trainerId = document.getElementById('historyTrainerFilter').value;

            // Filtrar clases
            let filteredClasses = staffClasses;

            if (startDate && endDate) {
                filteredClasses = filteredClasses.filter(record => 
                    record.date >= startDate && record.date <= endDate
                );
            }

            if (trainerId) {
                filteredClasses = filteredClasses.filter(record => record.trainerId === trainerId);
            }

            // Ordenar por fecha (más reciente primero)
            filteredClasses.sort((a, b) => {
                const dateCompare = new Date(b.date) - new Date(a.date);
                if (dateCompare !== 0) return dateCompare;
                
                // Si misma fecha, ordenar por hora
                const timeA = convertTimeToNumber(a.time);
                const timeB = convertTimeToNumber(b.time);
                return timeB - timeA;
            });

            // Mostrar resultados
            const classHistoryList = document.getElementById('classHistoryList');
            if (!classHistoryList) return;
            
            classHistoryList.innerHTML = '';

            let totalClasses = 0;
            let totalHours = 0;

            filteredClasses.forEach(record => {
                const trainer = users.find(u => u.id === record.trainerId) || { name: 'Entrenador no encontrado' };
                const classValue = parseFloat(record.duration) * HOURLY_RATE;
                
                totalClasses++;
                totalHours += parseFloat(record.duration);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td><span class="class-time-badge">${record.time}</span></td>
                    <td>${trainer.name}</td>
                    <td>${record.classType}</td>
                    <td>${record.duration} horas</td>
                    <td>$${HOURLY_RATE.toLocaleString('es-ES')}</td>
                    <td>$${classValue.toLocaleString('es-ES')}</td>
                    <td>${record.notes || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteStaffClass(${record.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                classHistoryList.appendChild(row);
            });

            // Actualizar estadísticas
            const totalClassesHistory = document.getElementById('totalClassesHistory');
            const totalHoursHistory = document.getElementById('totalHoursHistory');
            
            if (totalClassesHistory) totalClassesHistory.textContent = totalClasses;
            if (totalHoursHistory) totalHoursHistory.textContent = totalHours.toFixed(1);

            if (filteredClasses.length === 0) {
                classHistoryList.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center text-muted">
                            No se encontraron clases en el período seleccionado
                        </td>
                    </tr>
                `;
            }
        }

        // NUEVO: Función para convertir hora a número para ordenamiento
        function convertTimeToNumber(timeStr) {
            const [time, period] = timeStr.split(' ');
            const [hours, minutes] = time.split(':').map(Number);
            
            let hourNumber = hours;
            if (period === 'pm' && hours !== 12) {
                hourNumber += 12;
            } else if (period === 'am' && hours === 12) {
                hourNumber = 0;
            }
            
            return hourNumber * 60 + minutes;
        }

        // NUEVO: Función para marcar pagos como realizados
        function markPaymentsAsPaid() {
            const startDate = document.getElementById('paymentStartDate').value;
            const endDate = document.getElementById('paymentEndDate').value;

            if (!startDate || !endDate) {
                alert('Por favor, calcule primero los pagos seleccionando un período.');
                return;
            }

            if (confirm('¿Marcar los pagos del período seleccionado como realizados?\n\nEsta acción registrará automáticamente los gastos de nómina.')) {
                // Filtrar clases en el período
                const filteredClasses = staffClasses.filter(record => 
                    record.date >= startDate && record.date <= endDate
                );

                // Agrupar por entrenador
                const classesByTrainer = {};
                filteredClasses.forEach(record => {
                    if (!classesByTrainer[record.trainerId]) {
                        classesByTrainer[record.trainerId] = [];
                    }
                    classesByTrainer[record.trainerId].push(record);
                });

                // Registrar gastos de nómina
                Object.keys(classesByTrainer).forEach(trainerId => {
                    const trainer = users.find(u => u.id === trainerId);
                    if (!trainer) return;

                    const classes = classesByTrainer[trainerId];
                    const totalHours = classes.reduce((sum, record) => sum + parseFloat(record.duration), 0);
                    const total = totalHours * HOURLY_RATE;

                    // Crear gasto de nómina
                    const payrollExpense = {
                        id: Date.now(),
                        date: new Date().toISOString().split('T')[0],
                        description: `Nómina ${trainer.name} - ${formatDate(startDate)} a ${formatDate(endDate)}`,
                        amount: total,
                        category: 'nómina',
                        account: 'efectivo', // Se puede cambiar según necesidad
                        receipt: `CLASES-${startDate}-${endDate}`,
                        registeredAt: new Date().toISOString()
                    };

                    expenses.push(payrollExpense);
                });

                saveToLocalStorage();
                loadExpenses();
                loadAccountBalances();

                alert('Pagos marcados como realizados y gastos de nómina registrados correctamente.');
            }
        }

        // =============================================
        // FUNCIONES DE EXPORTACIÓN COMPLETAS
        // =============================================

        // NUEVO: Función para exportar reporte financiero a Excel
        function exportFinancialReport() {
            const monthInput = document.getElementById('financialReportMonth').value;
            if (!monthInput) {
                alert('Por favor, genere primero un reporte financiero.');
                return;
            }

            // Obtener datos del reporte
            const totalIncomeReport = document.getElementById('totalIncomeReport');
            const totalExpensesReport = document.getElementById('totalExpensesReport');
            const netProfitReport = document.getElementById('netProfitReport');
            const profitMarginReport = document.getElementById('profitMarginReport');
            
            if (!totalIncomeReport || !totalExpensesReport || !netProfitReport || !profitMarginReport) {
                alert('No se puede exportar el reporte. Primero genere un reporte financiero.');
                return;
            }

            const monthlyIncome = parseFloat(totalIncomeReport.textContent.replace('$', '').replace(',', '')) || 0;
            const monthlyExpenses = parseFloat(totalExpensesReport.textContent.replace('$', '').replace(',', '')) || 0;
            const netProfit = parseFloat(netProfitReport.textContent.replace('$', '').replace(',', '')) || 0;
            const profitMargin = profitMarginReport.textContent;

            // Crear libro de trabajo
            let workbook = XLSX.utils.book_new();

            // Crear datos del reporte
            const reportData = [
                ['Reporte Financiero - Antología Box23'],
                [`Mes: ${monthInput}`],
                [`Fecha de generación: ${new Date().toLocaleDateString('es-ES')}`],
                [''],
                ['RESUMEN FINANCIERO'],
                ['Ingresos del mes', `$${monthlyIncome.toFixed(2)}`],
                ['Gastos del mes', `$${monthlyExpenses.toFixed(2)}`],
                ['Utilidad neta', `$${netProfit.toFixed(2)}`],
                ['Margen de utilidad', profitMargin],
                [''],
                ['DETALLE DE GASTOS POR CATEGORÍA'],
                ['Categoría', 'Monto', 'Porcentaje', 'Tendencia']
            ];

            // Agregar gastos por categoría
            const rows = document.querySelectorAll('#financialReportList tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 4) {
                    reportData.push([
                        cells[0].textContent,
                        cells[1].textContent,
                        cells[2].textContent,
                        cells[3].textContent
                    ]);
                }
            });

            const worksheet = XLSX.utils.aoa_to_sheet(reportData);
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Reporte Financiero');

            // Generar archivo
            const fileName = `reporte_financiero_${monthInput}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, fileName);

            alert(`Reporte financiero exportado como ${fileName}`);
        }

        // NUEVO: Función para exportar reporte de gastos a Excel
        function exportExpensesReport() {
            const startDate = document.getElementById('expenseStartDateFilter').value;
            const endDate = document.getElementById('expenseEndDateFilter').value;
            const category = document.getElementById('expenseCategoryFilter').value;
            const account = document.getElementById('expenseAccountFilter').value;

            // Filtrar gastos
            let filteredExpenses = expenses;

            if (startDate && endDate) {
                filteredExpenses = filteredExpenses.filter(e => e.date >= startDate && e.date <= endDate);
            }

            if (category) {
                filteredExpenses = filteredExpenses.filter(e => e.category === category);
            }

            if (account) {
                filteredExpenses = filteredExpenses.filter(e => e.account === account);
            }

            if (filteredExpenses.length === 0) {
                alert('No hay gastos para exportar con los filtros seleccionados.');
                return;
            }

            // Crear libro de trabajo
            let workbook = XLSX.utils.book_new();

            // Crear datos del reporte
            const reportData = [
                ['Reporte de Gastos - Antología Box23'],
                [`Período: ${startDate || 'Inicio'} - ${endDate || 'Fin'}`],
                [`Categoría: ${category || 'Todas'}`],
                [`Cuenta: ${account || 'Todas'}`],
                [`Fecha de generación: ${new Date().toLocaleDateString('es-ES')}`],
                [''],
                ['Fecha', 'Descripción', 'Categoría', 'Cuenta', 'Monto', 'Factura/Recibo']
            ];

            // Agregar gastos
            filteredExpenses.forEach(expense => {
                reportData.push([
                    expense.date,
                    expense.description,
                    formatCategoryName(expense.category),
                    expense.account,
                    parseFloat(expense.amount),
                    expense.receipt || ''
                ]);
            });

            // Agregar total
            const total = filteredExpenses.reduce((sum, expense) => sum + parseFloat(expense.amount), 0);
            reportData.push(['', '', '', '', `$${total.toFixed(2)}`, '']);

            const worksheet = XLSX.utils.aoa_to_sheet(reportData);
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Gastos');

            // Generar archivo
            const fileName = `reporte_gastos_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, fileName);

            alert(`Reporte de gastos exportado como ${fileName}`);
        }

        // NUEVO: Función para exportar reporte de pagos a entrenadores
        function exportPaymentsReport() {
            const startDate = document.getElementById('paymentStartDate').value;
            const endDate = document.getElementById('paymentEndDate').value;

            if (!startDate || !endDate) {
                alert('Por favor, calcule primero los pagos seleccionando un período.');
                return;
            }

            // Filtrar clases en el período
            const filteredClasses = staffClasses.filter(record => 
                record.date >= startDate && record.date <= endDate
            );

            if (filteredClasses.length === 0) {
                alert('No hay clases para exportar en el período seleccionado.');
                return;
            }

            // Agrupar por entrenador
            const classesByTrainer = {};
            filteredClasses.forEach(record => {
                if (!classesByTrainer[record.trainerId]) {
                    classesByTrainer[record.trainerId] = [];
                }
                classesByTrainer[record.trainerId].push(record);
            });

            // Crear libro de trabajo
            let workbook = XLSX.utils.book_new();

            // Crear datos del reporte
            const reportData = [
                ['Reporte de Pagos a Entrenadores - Antología Box23'],
                [`Período: ${startDate} - ${endDate}`],
                [`Valor por hora: $${HOURLY_RATE.toLocaleString('es-ES')}`],
                [`Fecha de generación: ${new Date().toLocaleDateString('es-ES')}`],
                [''],
                ['Entrenador', 'Clases dictadas', 'Total horas', 'Valor por hora', 'Total a pagar']
            ];

            let totalPayment = 0;

            // Agregar datos por entrenador
            Object.keys(classesByTrainer).forEach(trainerId => {
                const trainer = users.find(u => u.id === trainerId);
                if (!trainer) return;

                const classes = classesByTrainer[trainerId];
                const totalHours = classes.reduce((sum, record) => sum + parseFloat(record.duration), 0);
                const total = totalHours * HOURLY_RATE;
                totalPayment += total;

                reportData.push([
                    trainer.name,
                    classes.length,
                    totalHours.toFixed(1),
                    HOURLY_RATE,
                    total
                ]);
            });

            // Agregar total
            reportData.push(['', '', '', 'TOTAL', totalPayment]);

            const worksheet = XLSX.utils.aoa_to_sheet(reportData);
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Pagos Entrenadores');

            // Hoja detallada de clases
            const detailData = [
                ['Detalle de Clases por Entrenador'],
                [''],
                ['Fecha', 'Hora', 'Entrenador', 'Tipo de clase', 'Duración', 'Valor clase']
            ];

            filteredClasses.forEach(record => {
                const trainer = users.find(u => u.id === record.trainerId) || { name: 'Entrenador no encontrado' };
                const classValue = parseFloat(record.duration) * HOURLY_RATE;

                detailData.push([
                    record.date,
                    record.time,
                    trainer.name,
                    record.classType,
                    record.duration,
                    classValue
                ]);
            });

            const detailWorksheet = XLSX.utils.aoa_to_sheet(detailData);
            XLSX.utils.book_append_sheet(workbook, detailWorksheet, 'Detalle Clases');

            // Generar archivo
            const fileName = `reporte_pagos_entrenadores_${startDate}_${endDate}.xlsx`;
            XLSX.writeFile(workbook, fileName);

            alert(`Reporte de pagos exportado como ${fileName}`);
        }

        // =============================================
        // FUNCIONES FALTANTES COMPLETADAS
        // =============================================

        // Función para actualizar información del sistema
        function updateSystemInfo() {
            const infoUsers = document.getElementById('infoUsers');
            const infoAttendance = document.getElementById('infoAttendance');
            const infoIncome = document.getElementById('infoIncome');
            const infoExpenses = document.getElementById('infoExpenses');
            const infoStaffClasses = document.getElementById('infoStaffClasses');
            const infoTrainers = document.getElementById('infoTrainers');
            const infoLastBackup = document.getElementById('infoLastBackup');
            const infoTotalBalance = document.getElementById('infoTotalBalance');
            
            if (infoUsers) infoUsers.textContent = users.length;
            if (infoAttendance) infoAttendance.textContent = attendance.length;
            if (infoIncome) infoIncome.textContent = income.length;
            if (infoExpenses) infoExpenses.textContent = expenses.length;
            if (infoStaffClasses) infoStaffClasses.textContent = staffClasses.length;
            if (infoTrainers) infoTrainers.textContent = users.filter(u => u.affiliationType === 'Entrenador(a)' && u.status === 'active').length;
            if (infoLastBackup) infoLastBackup.textContent = lastBackup;
            
            // Calcular saldo total
            const totalIncome = income.reduce((sum, payment) => sum + parseFloat(payment.amount), 0);
            const totalExpenses = expenses.reduce((sum, expense) => sum + parseFloat(expense.amount), 0);
            const totalBalance = totalIncome - totalExpenses;
            if (infoTotalBalance) infoTotalBalance.textContent = `$${totalBalance.toLocaleString('es-ES', {minimumFractionDigits: 0})}`;
        }

        // Función para preprocesar datos de importación
        function preprocessImportData(workbook) {
            // Limpiar datos de importación previos
            importData = {
                users: [],
                attendance: [],
                income: [],
                expenses: [],
                staffClasses: [],
                summary: {
                    users: { success: 0, warnings: 0, errors: 0 },
                    attendance: { success: 0, warnings: 0, errors: 0 },
                    income: { success: 0, warnings: 0, errors: 0 },
                    expenses: { success: 0, warnings: 0, errors: 0 },
                    staffClasses: { success: 0, warnings: 0, errors: 0 }
                }
            };

            // Procesar cada hoja
            workbook.SheetNames.forEach(sheetName => {
                const worksheet = workbook.Sheets[sheetName];
                const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                if (sheetName === 'Usuarios') {
                    processUserImportData(data);
                } else if (sheetName === 'Asistencias') {
                    processAttendanceImportData(data);
                } else if (sheetName === 'Pagos') {
                    processIncomeImportData(data);
                } else if (sheetName === 'Gastos') {
                    processExpensesImportData(data);
                } else if (sheetName === 'Clases Personal') {
                    processStaffClassesImportData(data);
                }
            });

            // Mostrar resumen de importación
            showImportSummary();
        }

        // Función para procesar datos de usuarios en importación
        function processUserImportData(data) {
            if (data.length < 2) return;

            // Suponemos que la primera fila son los encabezados
            const headers = data[0];
            
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (row.length === 0) continue;

                try {
                    const user = {
                        id: row[headers.indexOf('ID')] || generateNextUserId(),
                        name: row[headers.indexOf('Nombre')] || '',
                        document: row[headers.indexOf('Documento')] || '',
                        birthdate: convertToISODate(row[headers.indexOf('Fecha Nacimiento')]),
                        phone: formatPhone(row[headers.indexOf('Telefono')]) || '',
                        eps: row[headers.indexOf('EPS')] || '',
                        rh: row[headers.indexOf('RH')] || '',
                        pathology: row[headers.indexOf('Patologia')] || '',
                        emergencyContact: row[headers.indexOf('Contacto Emergencia')] || '',
                        emergencyPhone: formatPhone(row[headers.indexOf('Telefono Emergencia')]) || '',
                        classTime: row[headers.indexOf('Clase')] || '',
                        affiliationType: row[headers.indexOf('Tipo Afiliacion')] || '',
                        status: row[headers.indexOf('Estado')] || 'active',
                        createdAt: row[headers.indexOf('Fecha Registro')] || new Date().toISOString()
                    };

                    // Validaciones básicas
                    if (!user.name || !user.document) {
                        importData.summary.users.errors++;
                        continue;
                    }

                    importData.users.push(user);
                    importData.summary.users.success++;
                } catch (error) {
                    importData.summary.users.errors++;
                }
            }
        }

        // Función para procesar datos de asistencias en importación
        function processAttendanceImportData(data) {
            if (data.length < 2) return;

            const headers = data[0];
            
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (row.length === 0) continue;

                try {
                    const attendanceRecord = {
                        id: row[headers.indexOf('ID')] || Date.now() + i,
                        userId: row[headers.indexOf('UsuarioID')] || '',
                        date: convertToISODate(row[headers.indexOf('Fecha')]) || new Date().toISOString().split('T')[0],
                        status: row[headers.indexOf('Estado')] || 'presente',
                        registeredAt: row[headers.indexOf('Fecha Registro')] || new Date().toISOString()
                    };

                    // Validaciones básicas
                    if (!attendanceRecord.userId || !attendanceRecord.date) {
                        importData.summary.attendance.errors++;
                        continue;
                    }

                    importData.attendance.push(attendanceRecord);
                    importData.summary.attendance.success++;
                } catch (error) {
                    importData.summary.attendance.errors++;
                }
            }
        }

        // Función para procesar datos de pagos en importación
        function processIncomeImportData(data) {
            if (data.length < 2) return;

            const headers = data[0];
            
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (row.length === 0) continue;

                try {
                    const incomeRecord = {
                        id: row[headers.indexOf('ID')] || Date.now() + i,
                        userId: row[headers.indexOf('UsuarioID')] || '',
                        paymentDate: convertToISODate(row[headers.indexOf('Fecha Pago')]) || new Date().toISOString().split('T')[0],
                        startDate: convertToISODate(row[headers.indexOf('Fecha Inicio')]) || new Date().toISOString().split('T')[0],
                        endDate: convertToISODate(row[headers.indexOf('Fecha Fin')]) || new Date().toISOString().split('T')[0],
                        amount: parseFloat(row[headers.indexOf('Monto')]) || 0,
                        paymentType: row[headers.indexOf('Tipo Pago')] || '',
                        account: row[headers.indexOf('Cuenta')] || 'efectivo',
                        description: row[headers.indexOf('Descripción')] || '',
                        registeredAt: row[headers.indexOf('Fecha Registro')] || new Date().toISOString()
                    };

                    // Validaciones básicas
                    if (!incomeRecord.userId || !incomeRecord.amount || incomeRecord.amount <= 0) {
                        importData.summary.income.errors++;
                        continue;
                    }

                    importData.income.push(incomeRecord);
                    importData.summary.income.success++;
                } catch (error) {
                    importData.summary.income.errors++;
                }
            }
        }

        // Función para procesar datos de gastos en importación
        function processExpensesImportData(data) {
            if (data.length < 2) return;

            const headers = data[0];
            
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (row.length === 0) continue;

                try {
                    const expenseRecord = {
                        id: row[headers.indexOf('ID')] || Date.now() + i,
                        date: convertToISODate(row[headers.indexOf('Fecha')]) || new Date().toISOString().split('T')[0],
                        description: row[headers.indexOf('Descripción')] || '',
                        amount: parseFloat(row[headers.indexOf('Monto')]) || 0,
                        category: row[headers.indexOf('Categoría')] || 'otros',
                        account: row[headers.indexOf('Cuenta')] || 'efectivo',
                        receipt: row[headers.indexOf('Factura')] || '',
                        registeredAt: row[headers.indexOf('Fecha Registro')] || new Date().toISOString()
                    };

                    // Validaciones básicas
                    if (!expenseRecord.description || !expenseRecord.amount || expenseRecord.amount <= 0) {
                        importData.summary.expenses.errors++;
                        continue;
                    }

                    importData.expenses.push(expenseRecord);
                    importData.summary.expenses.success++;
                } catch (error) {
                    importData.summary.expenses.errors++;
                }
            }
        }

        // Función para procesar datos de clases de personal en importación
        function processStaffClassesImportData(data) {
            if (data.length < 2) return;

            const headers = data[0];
            
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (row.length === 0) continue;

                try {
                    const classRecord = {
                        id: row[headers.indexOf('ID')] || Date.now() + i,
                        date: convertToISODate(row[headers.indexOf('Fecha')]) || new Date().toISOString().split('T')[0],
                        time: row[headers.indexOf('Hora')] || '',
                        trainerId: row[headers.indexOf('EntrenadorID')] || '',
                        classType: row[headers.indexOf('Tipo Clase')] || '',
                        duration: parseFloat(row[headers.indexOf('Duración')]) || 1,
                        notes: row[headers.indexOf('Notas')] || '',
                        registeredAt: row[headers.indexOf('Fecha Registro')] || new Date().toISOString()
                    };

                    // Validaciones básicas
                    if (!classRecord.trainerId || !classRecord.date) {
                        importData.summary.staffClasses.errors++;
                        continue;
                    }

                    importData.staffClasses.push(classRecord);
                    importData.summary.staffClasses.success++;
                } catch (error) {
                    importData.summary.staffClasses.errors++;
                }
            }
        }

        // Función para mostrar resumen de importación
        function showImportSummary() {
            const importSummaryContent = document.getElementById('importSummaryContent');
            if (!importSummaryContent) return;
            
            let html = '<div class="import-summary">';
            
            // Resumen general
            html += '<h6>Resumen de Importación</h6>';
            html += '<div class="alert alert-info">';
            html += `<p>Total de registros a importar: ${importData.users.length + importData.attendance.length + importData.income.length + importData.expenses.length + importData.staffClasses.length}</p>`;
            html += '</div>';

            // Detalle por categoría
            const categories = [
                { name: 'Usuarios', data: importData.users, summary: importData.summary.users },
                { name: 'Asistencias', data: importData.attendance, summary: importData.summary.attendance },
                { name: 'Pagos', data: importData.income, summary: importData.summary.income },
                { name: 'Gastos', data: importData.expenses, summary: importData.summary.expenses },
                { name: 'Clases Personal', data: importData.staffClasses, summary: importData.summary.staffClasses }
            ];

            categories.forEach(category => {
                if (category.data.length > 0) {
                    html += `<div class="import-summary-item">`;
                    html += `<strong>${category.name}:</strong> `;
                    html += `<span class="import-success">${category.summary.success} exitosos</span>, `;
                    html += `<span class="import-warning">${category.summary.warnings} con advertencias</span>, `;
                    html += `<span class="import-error">${category.summary.errors} con errores</span>`;
                    html += `</div>`;
                }
            });

            html += '</div>';

            // Advertencia si se reemplazarán datos
            const replaceData = document.getElementById('replaceData')?.checked;
            if (replaceData) {
                html += '<div class="alert alert-warning mt-3">';
                html += '<i class="fas fa-exclamation-triangle"></i> ';
                html += '<strong>Advertencia:</strong> Se reemplazarán todos los datos existentes.';
                html += '</div>';
            }

            importSummaryContent.innerHTML = html;

            // Mostrar modal
            const importSummaryModal = new bootstrap.Modal(document.getElementById('importSummaryModal'));
            importSummaryModal.show();
        }

        // Función para confirmar importación
        function confirmImport() {
            const replaceData = document.getElementById('replaceData')?.checked;

            if (replaceData) {
                // Reemplazar todos los datos
                users = importData.users;
                attendance = importData.attendance;
                income = importData.income;
                expenses = importData.expenses;
                staffClasses = importData.staffClasses;
            } else {
                // Agregar a los datos existentes
                users.push(...importData.users);
                attendance.push(...importData.attendance);
                income.push(...importData.income);
                expenses.push(...importData.expenses);
                staffClasses.push(...importData.staffClasses);
            }

            // Guardar en localStorage
            saveToLocalStorage();

            // Recargar vistas
            loadUsers();
            loadAttendanceByClass();
            loadAttendance();
            loadIncome();
            loadExpenses();
            loadStaffClasses();
            updateSystemInfo();

            // Cerrar modal
            const importSummaryModal = bootstrap.Modal.getInstance(document.getElementById('importSummaryModal'));
            if (importSummaryModal) importSummaryModal.hide();

            alert('Datos importados correctamente!');
        }

        // Función para obtener información de cumpleaños próximos
        function getUpcomingBirthdayInfo(birthdate) {
            if (!birthdate) return null;

            const today = new Date();
            const birthDate = new Date(birthdate);
            const nextBirthday = new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate());

            // Si el cumpleaños ya pasó este año, calcular para el próximo año
            if (nextBirthday < today) {
                nextBirthday.setFullYear(today.getFullYear() + 1);
            }

            // Calcular días hasta el cumpleaños
            const diffTime = nextBirthday - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            // Mostrar solo si es dentro de los próximos 30 días
            if (diffDays <= 30) {
                return {
                    date: nextBirthday,
                    daysUntil: diffDays
                };
            }

            return null;
        }

        // Función para verificar cumpleaños próximos
        function checkUpcomingBirthdays() {
            const usersWithBirthdays = users.filter(user => {
                const birthdayInfo = getUpcomingBirthdayInfo(user.birthdate);
                return birthdayInfo !== null && birthdayInfo.daysUntil <= 7; // Solo próximos 7 días
            });

            if (usersWithBirthdays.length > 0) {
                console.log(`Hay ${usersWithBirthdays.length} usuarios con cumpleaños próximos`);
                // Podrías mostrar una notificación aquí si lo deseas
            }
        }

        // Función para mostrar cumpleaños
        function showBirthdays(type) {
            const birthdayContent = document.getElementById('birthdayContent');
            if (!birthdayContent) return;
            
            birthdayContent.innerHTML = '';

            let filteredUsers = [];
            const today = new Date();
            const currentMonth = today.getMonth() + 1;

            if (type === 'month') {
                const birthdayModalTitle = document.getElementById('birthdayModalTitle');
                if (birthdayModalTitle) birthdayModalTitle.textContent = 'Cumpleaños del Mes';
                
                filteredUsers = users.filter(user => {
                    if (!user.birthdate) return false;
                    const birthDate = new Date(user.birthdate);
                    return birthDate.getMonth() + 1 === currentMonth;
                });
            } else {
                const birthdayModalTitle = document.getElementById('birthdayModalTitle');
                if (birthdayModalTitle) birthdayModalTitle.textContent = 'Cumpleaños Próximos (7 días)';
                
                filteredUsers = users.filter(user => {
                    const birthdayInfo = getUpcomingBirthdayInfo(user.birthdate);
                    return birthdayInfo !== null && birthdayInfo.daysUntil <= 7;
                });
            }

            if (filteredUsers.length === 0) {
                birthdayContent.innerHTML = '<p class="text-center text-muted">No hay cumpleaños en este período.</p>';
            } else {
                filteredUsers.forEach(user => {
                    const birthdayInfo = getUpcomingBirthdayInfo(user.birthdate);
                    const birthdayItem = document.createElement('div');
                    birthdayItem.className = 'birthday-item';
                    birthdayItem.innerHTML = `
                        <div class="birthday-user-info">
                            <div class="birthday-user-name">${user.name}</div>
                            <div class="birthday-user-details">
                                Teléfono: ${user.phone || 'No registrado'} | 
                                Fecha: ${formatDate(user.birthdate)} |
                                <span class="birthday-date">Faltan ${birthdayInfo.daysUntil} días</span>
                            </div>
                        </div>
                        <div class="birthday-actions">
                            <button class="btn btn-sm btn-success" onclick="sendBirthdayMessage('${user.id}')">
                                <i class="fab fa-whatsapp"></i> Felicitar
                            </button>
                        </div>
                    `;
                    birthdayContent.appendChild(birthdayItem);
                });
            }

            const birthdayModal = new bootstrap.Modal(document.getElementById('birthdayModal'));
            birthdayModal.show();
        }

        // Función para enviar mensaje de cumpleaños
        function sendBirthdayMessage(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            // Rellenar el formulario de WhatsApp
            document.getElementById('whatsappNumber').value = cleanPhone(user.phone);

            // Crear mensaje de cumpleaños
            const message = `¡Feliz cumpleaños ${user.name}! 🎉🎂

Desde Antología Box23 te deseamos un día maravilloso lleno de alegría, salud y muchas bendiciones. Que este nuevo año de vida esté cargado de éxitos y momentos inolvidables.

¡Esperamos verte pronto en el box para celebrar contigo! 💪

Con cariño,
El equipo de Antología Box23`;

            document.getElementById('whatsappMessage').value = message;
            document.getElementById('messagePreview').textContent = message;

            // Actualizar enlace de WhatsApp
            updateWhatsAppLink();

            // Mostrar modal de WhatsApp
            const whatsappModal = new bootstrap.Modal(document.getElementById('whatsappModal'));
            whatsappModal.show();
        }

        // Función para enviar felicitaciones de cumpleaños en lote
        function sendBirthdayWishes() {
            const birthdayItems = document.querySelectorAll('.birthday-item');
            let count = 0;

            birthdayItems.forEach(item => {
                const button = item.querySelector('.btn-success');
                if (!button) return;
                
                const onclickAttr = button.getAttribute('onclick');
                if (!onclickAttr) return;
                
                const match = onclickAttr.match(/'([^']+)'/);
                if (!match) return;
                
                const userId = match[1];
                const user = users.find(u => u.id === userId);
                
                if (user && isValidPhone(user.phone)) {
                    // Aquí podrías implementar el envío automático en lote
                    // Por ahora solo contamos
                    count++;
                }
            });

            alert(`Se enviarán felicitaciones a ${count} usuarios. Por favor, felicítalos individualmente haciendo clic en el botón "Felicitar" de cada uno.`);
        }

        // Función para generar reporte combinado
        function generateCombinedReport() {
            const userId = document.getElementById('combinedReportUser').value;
            const startDate = document.getElementById('combinedReportStartDate').value;
            const endDate = document.getElementById('combinedReportEndDate').value;

            if (!startDate || !endDate) {
                alert('Por favor, seleccione un rango de fechas.');
                return;
            }

            // Filtrar usuarios
            let filteredUsers = users;
            if (userId) {
                filteredUsers = filteredUsers.filter(u => u.id === userId);
            }

            // Obtener usuarios activos (excepto entrenadores)
            filteredUsers = filteredUsers.filter(u => u.status === 'active' && u.affiliationType !== 'Entrenador(a)');

            // Generar reporte
            const combinedReportList = document.getElementById('combinedReportList');
            if (!combinedReportList) return;
            
            combinedReportList.innerHTML = '';

            filteredUsers.forEach(user => {
                // Obtener información de membresía
                const membershipStatus = checkMembershipStatus(user.id);
                
                // Contar asistencias en el período
                const userAttendance = attendance.filter(a => 
                    a.userId === user.id && 
                    a.status === 'presente' &&
                    a.date >= startDate && 
                    a.date <= endDate
                ).length;

                // Obtener último pago
                const lastPayment = getLastPayment(user.id);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.phone || '-'}</td>
                    <td>${userAttendance}</td>
                    <td>${membershipStatus.classesAfterExpiration || 0}</td>
                    <td>${lastPayment ? formatDate(lastPayment.endDate) : 'Sin pago'}</td>
                    <td>${lastPayment ? lastPayment.paymentType : '-'}</td>
                    <td>${lastPayment ? `$${parseFloat(lastPayment.amount).toFixed(2)}` : '-'}</td>
                    <td>
                        <span class="badge ${membershipStatus.expired ? 'bg-danger' : 'bg-success'}">
                            ${membershipStatus.expired ? 'Vencida' : 'Activa'}
                        </span>
                    </td>
                `;
                combinedReportList.appendChild(row);
            });

            if (filteredUsers.length === 0) {
                combinedReportList.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            No hay datos para mostrar con los filtros seleccionados
                        </td>
                    </tr>
                `;
            }
        }

        // Función para exportar reporte combinado
        function exportCombinedReport() {
            // Implementación similar a otras funciones de exportación
            alert('Funcionalidad de exportación de reporte combinado en desarrollo.');
        }

        // Función para generar reporte mensual de asistencias
        function generateAttendanceMonthlyReport() {
            const monthInput = document.getElementById('attendanceMonth').value;
            if (!monthInput) {
                alert('Por favor, seleccione un mes.');
                return;
            }

            // Obtener el primer y último día del mes
            const [year, month] = monthInput.split('-');
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0);

            const startDateStr = startDate.toISOString().split('T')[0];
            const endDateStr = endDate.toISOString().split('T')[0];

            // Obtener usuarios activos (excepto entrenadores)
            const activeUsers = users.filter(u => u.status === 'active' && u.affiliationType !== 'Entrenador(a)');

            // Generar reporte
            const attendanceMonthlyList = document.getElementById('attendanceMonthlyList');
            if (!attendanceMonthlyList) return;
            
            attendanceMonthlyList.innerHTML = '';

            activeUsers.forEach((user, index) => {
                // Contar asistencias en el mes
                const userAttendance = attendance.filter(a => 
                    a.userId === user.id && 
                    a.status === 'presente' &&
                    a.date >= startDateStr && 
                    a.date <= endDateStr
                );

                const attendanceCount = userAttendance.length;
                
                // Calcular días del mes (aproximado)
                const daysInMonth = endDate.getDate();
                const attendancePercentage = daysInMonth > 0 ? (attendanceCount / daysInMonth * 100).toFixed(1) : 0;

                // Obtener última asistencia
                let lastAttendance = '-';
                if (userAttendance.length > 0) {
                    const lastDate = userAttendance.reduce((latest, current) => 
                        new Date(current.date) > new Date(latest.date) ? current : latest
                    ).date;
                    lastAttendance = formatDate(lastDate);
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.name}</td>
                    <td>${user.classTime || '-'}</td>
                    <td>${attendanceCount}</td>
                    <td>${attendancePercentage}%</td>
                    <td>${lastAttendance}</td>
                `;
                attendanceMonthlyList.appendChild(row);
            });

            if (activeUsers.length === 0) {
                attendanceMonthlyList.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            No hay usuarios activos para mostrar
                        </td>
                    </tr>
                `;
            }
        }

        // Función para generar reporte mensual de pagos
        function generateIncomeMonthlyReport() {
            const monthInput = document.getElementById('incomeMonth').value;
            if (!monthInput) {
                alert('Por favor, seleccione un mes.');
                return;
            }

            // Obtener el primer y último día del mes
            const [year, month] = monthInput.split('-');
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0);

            const startDateStr = startDate.toISOString().split('T')[0];
            const endDateStr = endDate.toISOString().split('T')[0];

            // Filtrar pagos del mes
            const monthlyPayments = income.filter(payment => 
                payment.paymentDate >= startDateStr && payment.paymentDate <= endDateStr
            );

            // Agrupar por tipo de pago
            const paymentsByType = {};
            monthlyPayments.forEach(payment => {
                const type = payment.paymentType || 'Otros';
                if (!paymentsByType[type]) {
                    paymentsByType[type] = {
                        count: 0,
                        amount: 0
                    };
                }
                paymentsByType[type].count++;
                paymentsByType[type].amount += parseFloat(payment.amount);
            });

            // Calcular totales
            const totalCount = monthlyPayments.length;
            const totalAmount = monthlyPayments.reduce((sum, payment) => sum + parseFloat(payment.amount), 0);

            // Actualizar tabla
            const incomeMonthlyList = document.getElementById('incomeMonthlyList');
            if (!incomeMonthlyList) return;
            
            incomeMonthlyList.innerHTML = '';

            Object.keys(paymentsByType).forEach(type => {
                const data = paymentsByType[type];
                const percentage = totalAmount > 0 ? (data.amount / totalAmount * 100).toFixed(1) : 0;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${type}</td>
                    <td>${data.count}</td>
                    <td>$${data.amount.toFixed(2)}</td>
                    <td>${percentage}%</td>
                `;
                incomeMonthlyList.appendChild(row);
            });

            // Actualizar totales
            const totalPaymentsCount = document.getElementById('totalPaymentsCount');
            const totalPaymentsAmount = document.getElementById('totalPaymentsAmount');
            
            if (totalPaymentsCount) totalPaymentsCount.textContent = totalCount;
            if (totalPaymentsAmount) totalPaymentsAmount.textContent = `$${totalAmount.toFixed(2)}`;

            if (Object.keys(paymentsByType).length === 0) {
                incomeMonthlyList.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted">
                            No hay pagos en este mes
                        </td>
                    </tr>
                `;
            }

            // Actualizar gráfico
            updateIncomeMonthlyChart(paymentsByType);
        }

        // Función para actualizar gráfico de pagos mensuales
        function updateIncomeMonthlyChart(paymentsByType) {
            // Destruir gráfico existente si lo hay
            if (incomeMonthlyChart) {
                incomeMonthlyChart.destroy();
            }

            const ctx = document.getElementById('incomeMonthlyChart')?.getContext('2d');
            if (!ctx) return;
            
            const labels = Object.keys(paymentsByType);
            const data = labels.map(type => paymentsByType[type].amount);
            const backgroundColors = [
                '#27F9D4', '#FF729F', '#F0F66E', '#7C77B9', 
                '#1D8A99', '#F7934C', '#FFB347', '#25D366'
            ];

            incomeMonthlyChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors.slice(0, labels.length),
                        borderColor: 'var(--color-dark)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#f8f9fa',
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: $${value.toLocaleString('es-ES', {minimumFractionDigits: 2})} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Función para exportar reporte de asistencias
        function exportAttendanceReport() {
            alert('Funcionalidad de exportación de reporte de asistencias en desarrollo.');
        }

        // Función para exportar reporte de pagos
        function exportIncomeReport() {
            alert('Funcionalidad de exportación de reporte de pagos en desarrollo.');
        }

        // Función para actualizar gráficos
        function updateCharts() {
            // Implementación básica - puedes expandir esto según necesites
            console.log('Actualizando gráficos...');
        }

        // Inicializar la aplicación cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function () {
            try {
                initializeApp();
                checkAutoBackup();

                // Verificar cumpleaños próximos al cargar la aplicación
                setTimeout(() => {
                    checkUpcomingBirthdays();
                }, 1000);
            } catch (error) {
                console.error("Error al inicializar la aplicación:", error);
                alert("Ocurrió un error al inicializar la aplicación. Por favor, recarga la página.");
            }
        });
    </script>
</body>
</html>